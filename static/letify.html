<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<style id="pre-theme">
  html,body,#root,#splash{background:#FAF7F2 !important}
  html.pre-dark,html.pre-dark body,html.pre-dark #root,html.pre-dark #splash{background:#111111 !important;color:#fff !important}
</style>
<script>
(function(){
  var tgScheme=null;
  try{tgScheme=window.Telegram?.WebApp?.colorScheme;}catch(e){}
  var dark=tgScheme==='dark'||window.matchMedia('(prefers-color-scheme:dark)').matches;
  if(dark)document.documentElement.classList.add('pre-dark');
})();
</script>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache,no-store,must-revalidate">
<title>letify</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Onest:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}
:root{
  --bg:#FAF7F2;--bg2:#fff;--bg3:rgba(0,0,0,.05);
  --text:#1C1608;--hint:#A89F90;--brd:rgba(0,0,0,.07);
  --sun:#FF6B35;--sun2:#FFAB40;--water:#4EAEE5;--cal:#F4814A;
  --sleep:#8B7FD4;--green:#52C177;--red:#F45C5C;
  --r:14px;--r-lg:18px;
  --st:0px;--sb:0px;
  --sh:0 1px 8px rgba(0,0,0,.06),0 2px 4px rgba(0,0,0,.04);
  --nav-h:calc(62px + var(--sb));
  --page-bot:calc(var(--nav-h) + 16px);
  --page-top:calc(var(--st) + 16px);
}
.pre-dark{
  --bg:#111111;--bg2:#111111;--bg3:rgba(255,255,255,.07);
  --text:#ffffff;--hint:#708499;
}
html,body{height:100%;overflow:hidden;font-family:'Onest',system-ui,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;overscroll-behavior:none;user-select:none}
#root{position:fixed;inset:0}
#pages{position:absolute;inset:0}

/* ‚ïê‚ïê SPLASH ‚ïê‚ïê */
#splash{
  position:fixed;inset:0;z-index:99999;
  background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:0;
  transition:opacity .5s ease,transform .5s ease;
  will-change:opacity,transform;
  overflow:hidden;
}
#splash::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse 45% 30% at 50% 40%, rgba(255,107,53,.10) 0%, transparent 70%);
  pointer-events:none;
}
#splash.hiding{opacity:0;transform:scale(1.04);}
.sp-dots{display:flex;gap:8px;}
.sp-dot{width:8px;height:8px;border-radius:50%;background:linear-gradient(135deg,var(--sun),var(--sun2));animation:sp-bounce 1.5s ease-in-out infinite;}
.sp-dot:nth-child(2){animation-delay:.18s;opacity:.65;}
.sp-dot:nth-child(3){animation-delay:.36s;opacity:.35;}
@keyframes sp-bounce{0%,100%{transform:translateY(0);opacity:.5}50%{transform:translateY(-5px);opacity:1}}

/* ‚ïê‚ïê MAIN PAGES ‚ïê‚ïê */
.page{
  position:absolute;inset:0;
  overflow-y:auto;overflow-x:hidden;
  -webkit-overflow-scrolling:touch;touch-action:pan-y;
  scrollbar-width:none;
  padding-top:var(--page-top);
  padding-bottom:var(--page-bot);
  opacity:0;pointer-events:none;
  transform:translateY(6px);
  transition:opacity .2s ease,transform .2s ease;
}
.page::-webkit-scrollbar{display:none}
.page.active{opacity:1;pointer-events:all;transform:none}

/* ‚ïê‚ïê PUSH PAGES ‚ïê‚ïê */
.push-page{
  position:fixed;inset:0;z-index:60;
  background:var(--bg);
  overflow-y:auto;overflow-x:hidden;
  -webkit-overflow-scrolling:touch;touch-action:pan-y;
  scrollbar-width:none;
  opacity:0;
  transform:translateX(28px);
  transition:opacity .22s ease, transform .22s ease;
  pointer-events:none;
  display:flex;flex-direction:column;
  backface-visibility:hidden;-webkit-backface-visibility:hidden;
}
.push-page::-webkit-scrollbar{display:none}
.push-page.open{opacity:1;transform:translateX(0);pointer-events:all}
.pp-hdr{
  flex-shrink:0;
  padding-top:calc(var(--st) + 10px);padding-bottom:12px;
  padding-left:16px;padding-right:16px;
  display:flex;align-items:center;gap:12px;
  border-bottom:1px solid var(--brd);background:var(--bg);
}
.tg-env .pp-back{display:none !important}
.pp-back{
  width:36px;height:36px;border-radius:12px;
  background:var(--bg3);display:flex;align-items:center;justify-content:center;
  cursor:pointer;border:none;color:var(--text);flex-shrink:0;
  transition:transform .1s,background .1s;
}
.pp-back:active{transform:scale(.95);transition:transform .07s ease;background:rgba(0,0,0,.07)}
.tg-dark .pp-back:active{background:rgba(255,255,255,.18)}
.pp-title{font-size:18px;font-weight:900;letter-spacing:-.02em}
.pp-subtitle{font-size:11px;font-weight:500;color:var(--hint);margin-top:1px}
.pp-body{
  flex:1;overflow-y:auto;overflow-x:hidden;
  -webkit-overflow-scrolling:touch;scrollbar-width:none;
  padding:16px;padding-bottom:calc(var(--sb) + 24px);
}
.pp-body::-webkit-scrollbar{display:none}

/* ‚ïê‚ïê MD3 FIELDS ‚ïê‚ïê */
.m3-field{position:relative;margin-bottom:8px}
.m3-field:last-child{margin-bottom:0}
.m3-input{
  width:100%;min-height:54px;
  padding:20px 14px 6px;
  font-family:inherit;font-size:16px;font-weight:700;
  color:var(--text);background:var(--bg3);
  border:none;outline:none;border-radius:12px;
  -webkit-appearance:none;
  transition:background .15s,box-shadow .15s;
}
.m3-input:focus{background:rgba(255,107,53,.08);box-shadow:0 0 0 2px rgba(255,107,53,.3)}
.tg-dark .m3-input:focus{background:rgba(255,107,53,.15)}
.m3-label{
  position:absolute;top:8px;left:14px;
  font-size:10px;font-weight:700;color:var(--hint);
  letter-spacing:.05em;text-transform:uppercase;pointer-events:none;
}
.m3-input.num{text-align:right}
.m3-input::placeholder{color:var(--hint);font-size:14px;font-weight:500}
.m3-card{
  background:var(--bg2);border-radius:16px;
  padding:14px;box-shadow:var(--sh);margin-bottom:10px;
}
.tg-dark .m3-card{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.09);box-shadow:none}
.m3-sec{font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--hint);padding:12px 2px 6px}
.m3-sec:first-child{padding-top:0}
.m3-seg{display:flex;gap:4px;background:var(--bg3);border-radius:12px;padding:3px;margin-bottom:10px}
.m3-seg-btn{
  flex:1;padding:10px 6px;font-size:13px;font-weight:700;
  border:none;border-radius:9px;cursor:pointer;font-family:inherit;
  background:transparent;color:var(--hint);
  transition:background .14s ease,color .14s ease,box-shadow .14s ease,transform .12s ease;white-space:nowrap;
}
.m3-seg-btn:active{transform:scale(.96);opacity:.9;transition:transform .08s ease,opacity .08s ease}
.m3-seg-btn.on{background:var(--bg2);color:var(--text);box-shadow:0 1px 5px rgba(0,0,0,.09)}
.tg-dark .m3-seg-btn.on{background:rgba(255,255,255,.16)}
.m3-seg-emoji .m3-seg-btn{font-size:22px;padding:7px 4px}

/* ‚ïê‚ïê STEPPER ‚ïê‚ïê */
.stepper-wrap{display:flex;align-items:center;gap:0;background:var(--bg3);border-radius:16px;overflow:hidden}
.stepper-btn{
  width:56px;height:64px;background:transparent;border:none;cursor:pointer;
  font-size:26px;font-weight:700;color:var(--sun);font-family:inherit;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  transition:background .1s;-webkit-tap-highlight-color:transparent;
}
.stepper-val{
  flex:1;text-align:center;font-size:38px;font-weight:700;letter-spacing:-.02em;
  color:var(--text);padding:0 4px;user-select:none;
}
.stepper-val .unit{font-size:14px;font-weight:700;color:var(--hint);margin-left:4px}
.dual-stepper{display:flex;gap:8px;align-items:stretch}
.dual-stepper .stepper-wrap{flex:1}
.big-val-card{
  background:linear-gradient(135deg,rgba(255,107,53,.07),rgba(255,171,64,.04));
  border-radius:20px;padding:24px 20px;text-align:center;margin-bottom:16px;
}
.big-val{font-size:64px;font-weight:800;letter-spacing:-.03em;line-height:1;color:var(--text)}
.big-val-unit{font-size:16px;font-weight:700;color:var(--hint);margin-top:4px}

/* ‚ïê‚ïê NAV ‚ïê‚ïê */
#nav{
  position:fixed;bottom:12px;left:0;right:0;margin:0 auto;
  width:fit-content;z-index:9999;
  display:flex;align-items:center;gap:3px;padding:5px;
  background:rgba(255,255,255,.95);
  border:1px solid rgba(255,255,255,.9);
  border-radius:24px;
  box-shadow:0 6px 24px rgba(0,0,0,.12),0 2px 6px rgba(0,0,0,.06);
  transition:bottom .28s ease,opacity .22s ease;
}
.tg-dark #nav{background:rgba(24,18,10,.96);border-color:rgba(255,255,255,.1)}
#nav.gone{bottom:calc(-120px - var(--sb));opacity:0;pointer-events:none}
/* Nav item ‚Äî no dot, just icon centered */
.nt{
  width:50px;height:50px;border-radius:16px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:var(--hint);
  transition:color .15s ease-out,background .15s ease-out,transform .2s ease-out;
}
.nt.on{color:var(--sun);background:rgba(255,107,53,.1)}
.nt:active{transform:scale(.94);transition:transform .08s ease}
.nt svg{width:22px;height:22px;flex-shrink:0}

/* ‚ïê‚ïê TYPOGRAPHY ‚ïê‚ïê */
.t1{font-size:26px;font-weight:900;line-height:1.1;letter-spacing:-.02em}
.t2{font-size:20px;font-weight:900;letter-spacing:-.02em}
.t5{font-size:12px;font-weight:600;color:var(--hint)}
.grad{background:linear-gradient(105deg,var(--sun),var(--sun2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

/* ‚ïê‚ïê CARDS ‚ïê‚ïê */
.card{background:var(--bg2);border-radius:var(--r-lg);padding:16px;box-shadow:var(--sh);position:relative;overflow:hidden}
.tg-dark .card{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.09);box-shadow:none}
.pad{padding:0 16px}
.gap{margin-top:10px}
.sec{font-size:11px;font-weight:800;letter-spacing:.08em;text-transform:uppercase;color:var(--hint);padding:14px 20px 6px}
.tg-dark .sec{color:rgba(255,255,255,.35)}
.lt{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--brd);cursor:pointer;transition:opacity .12s}
.lt:last-child{border-bottom:none;padding-bottom:0}
.lt:first-child{padding-top:0}
.lt:active{opacity:.6;transition:opacity .07s ease}
.lt-ic{width:32px;height:32px;border-radius:10px;background:var(--bg3);display:flex;align-items:center;justify-content:center;color:var(--hint);flex-shrink:0}
.tg-dark .lt-ic{background:rgba(255,255,255,.08)}
.lt-lbl{flex:1;font-size:14px;font-weight:700}
.lt-val{font-size:12px;color:var(--hint);font-weight:600;flex-shrink:0}
.lt-chev{color:var(--hint);opacity:.4;flex-shrink:0}
.tg-dark .lt{border-bottom-color:rgba(255,255,255,.08)}

/* ‚ïê‚ïê PROGRESS BAR ‚ïê‚ïê */
.pb{height:6px;background:rgba(0,0,0,.06);border-radius:99px;overflow:hidden;margin-top:10px}
.pbf{height:100%;border-radius:99px;transition:width .8s cubic-bezier(.34,1.1,.64,1)}
.pb-sun{background:linear-gradient(90deg,var(--sun),var(--sun2))}
.pb-water{background:var(--water)}
.pb-sleep{background:var(--sleep)}
.tg-dark .pb{background:rgba(255,255,255,.1)}

/* ‚ïê‚ïê ARC ‚ïê‚ïê */
.aw{position:relative;display:inline-flex;align-items:center;justify-content:center}
.ai{position:absolute;text-align:center;pointer-events:none}

/* ‚ïê‚ïê STAT BOX ‚ïê‚ïê */
.sb-row{display:flex;gap:8px}
.sbox{flex:1;background:var(--bg2);border-radius:var(--r);padding:12px;box-shadow:var(--sh);text-align:center}
.tg-dark .sbox{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.09);box-shadow:none}
.sv{font-size:19px;font-weight:900;margin-bottom:2px}
.sl{font-size:10px;font-weight:700;color:var(--hint);text-transform:uppercase;letter-spacing:.06em}

/* ‚ïê‚ïê BANNER ‚ïê‚ïê */
.banner{background:linear-gradient(130deg,#FF6B35,#FFAB40);border-radius:var(--r-lg);padding:16px;color:#fff;position:relative;overflow:hidden}
.banner::after{content:'';position:absolute;right:-10px;top:-10px;width:80px;height:80px;border-radius:50%;background:rgba(255,255,255,.1);pointer-events:none}

/* ‚ïê‚ïê ACT CARD ‚ïê‚ïê */
.ac{
  background:var(--bg2);border-radius:var(--r);padding:12px;
  display:flex;align-items:flex-start;gap:10px;
  box-shadow:var(--sh);margin-bottom:8px;
  transition:opacity .16s;
  position:relative;overflow:hidden;
}
.tg-dark .ac{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.08);box-shadow:none}
.ac.done{opacity:.46}
.ac-ico{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.ac-body{flex:1;min-width:0}
.ac-name{font-size:14px;font-weight:800;margin-bottom:2px}
.ac-name.done-text{text-decoration:line-through;opacity:.6}
.ac-sub{font-size:11px;color:var(--hint);font-weight:600}
.pill{display:inline-flex;align-items:center;padding:3px 9px;border-radius:99px;font-size:10px;font-weight:800;white-space:nowrap;margin-top:5px}
.p-ok{background:rgba(82,193,119,.12);color:var(--green)}
.p-late{background:rgba(244,92,92,.1);color:var(--red)}
.p-soon{background:rgba(255,107,53,.1);color:var(--sun)}
.p-now{background:rgba(78,174,229,.12);color:var(--water)}
.p-later{background:rgba(0,0,0,.05);color:var(--hint)}
.ac-bar{margin-top:7px;height:4px;background:rgba(0,0,0,.06);border-radius:99px;overflow:hidden}
.ac-barf{height:100%;border-radius:99px;transition:width .4s ease}
.tg-dark .ac-bar{background:rgba(255,255,255,.1)}

/* ‚ïê‚ïê COMPLETING TIMER BAR ‚Äî 3.5s ‚ïê‚ïê */
.ac-timer-bar{
  position:absolute;bottom:0;left:0;
  height:3px;
  background:linear-gradient(90deg,rgba(82,193,119,.5),var(--green));
  border-radius:0 99px 99px 0;
  transition:width 3.55s linear;
  pointer-events:none;
}

/* ‚ïê‚ïê SLEEP DOTS ‚ïê‚ïê */
.sq{display:flex;gap:3px}
.sqd{width:14px;height:4px;border-radius:99px;background:rgba(0,0,0,.07)}
.sqd.on{background:var(--sleep)}
.tg-dark .sqd{background:rgba(255,255,255,.14)}

/* ‚ïê‚ïê HISTORY ROW ‚ïê‚ïê */
.hr{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid var(--brd);gap:10px}
.hr:last-child{border-bottom:none;padding-bottom:0}
.hr:first-child{padding-top:0}
.hr-d{font-size:11px;color:var(--hint);font-weight:700;min-width:46px}
.hr-v{font-size:15px;font-weight:900;flex:1}
.hr-diff{font-size:11px;font-weight:800}
.d-neg{color:var(--green)}.d-pos{color:var(--red)}
.tg-dark .hr{border-bottom-color:rgba(255,255,255,.08)}

/* ‚ïê‚ïê MEAL ROW ‚ïê‚ïê */
.mr{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--brd)}
.mr:last-child{border-bottom:none;padding-bottom:0}
.mr:first-child{padding-top:0}
.mr-ico{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.mr-name{font-size:13px;font-weight:800}
.mr-kcal{font-size:13px;font-weight:900;flex-shrink:0}
.tg-dark .mr{border-bottom-color:rgba(255,255,255,.08)}

/* ‚ïê‚ïê BTNS ‚ïê‚ïê */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border:none;cursor:pointer;font-family:inherit;font-weight:800;transition:transform .2s ease-out,opacity .2s ease-out}
.btn:active{transform:scale(.97);opacity:.9;transition:transform .08s ease,opacity .08s ease}
.btn-p{background:linear-gradient(135deg,var(--sun),var(--sun2));color:#fff;padding:15px 20px;font-size:15px;border-radius:14px;box-shadow:0 4px 16px rgba(255,107,53,.28);width:100%;letter-spacing:.01em}
.btn-g{background:var(--bg3);color:var(--text);padding:11px 16px;font-size:13px;border-radius:11px}
.btn-water{background:rgba(78,174,229,.1);color:var(--water);padding:13px 8px;font-size:13px;border-radius:12px;flex:1;font-weight:800}
.btn-danger{background:rgba(244,92,92,.09);color:var(--red);padding:11px 16px;font-size:13px;border-radius:11px;width:100%}
.tg-dark .btn-g{background:rgba(255,255,255,.1);color:#fff}
.tg-dark .btn-water{background:rgba(78,174,229,.18);color:#7ecef5}
.tg-dark .btn-danger{background:rgba(244,92,92,.15)}

/* ‚ïê‚ïê TOGGLE ‚ïê‚ïê */
.tog{width:46px;height:26px;border-radius:99px;position:relative;cursor:pointer;flex-shrink:0;transition:background .18s ease}
.tog::after{content:'';position:absolute;width:20px;height:20px;border-radius:50%;background:#fff;top:3px;transition:left .18s ease-in-out;box-shadow:0 1px 5px rgba(0,0,0,.16)}
.tog.on{background:var(--sun)}.tog.off{background:rgba(0,0,0,.16)}
.tog.on::after{left:23px}.tog.off::after{left:3px}
.tg-dark .tog.off{background:rgba(255,255,255,.22)}

/* ‚ïê‚ïê TRACK TABS ‚ïê‚ïê */
.ttabs{display:flex;gap:3px;background:rgba(0,0,0,.05);border-radius:12px;padding:3px}
.ttab{flex:1;padding:8px 4px;font-size:12px;font-weight:800;border:none;border-radius:9px;cursor:pointer;font-family:inherit;background:transparent;color:var(--hint);transition:background .14s ease-out,color .14s ease-out,box-shadow .14s ease-out,transform .18s ease-out}
.ttab:active{transform:scale(.96);transition:transform .07s ease}
.ttab.on{background:var(--bg2);color:var(--text);box-shadow:0 1px 5px rgba(0,0,0,.08)}
.tg-dark .ttabs{background:rgba(255,255,255,.08)}
.tg-dark .ttab.on{background:rgba(255,255,255,.16);color:#fff}
.tg-dark .ttab{color:rgba(255,255,255,.4)}

/* ‚ïê‚ïê AVATAR ‚ïê‚ïê */
.pav{width:64px;height:64px;border-radius:20px;background:linear-gradient(135deg,var(--sun),var(--sun2));display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:900;color:#fff;box-shadow:0 5px 18px rgba(255,107,53,.25);flex-shrink:0}

/* ‚ïê‚ïê TOAST ‚ïê‚ïê */
#toast{
  position:fixed;bottom:calc(var(--nav-h) + 12px);left:50%;
  transform:translateX(-50%) translateY(8px);
  background:rgba(28,22,14,.9);color:#fff;
  padding:9px 18px;border-radius:99px;font-size:13px;font-weight:800;
  white-space:nowrap;z-index:9998;opacity:0;pointer-events:none;
  transition:opacity .18s,transform .18s cubic-bezier(.34,1.2,.64,1);
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* ‚ïê‚ïê TYPE GRID ‚ïê‚ïê */
.type-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:4px}
.type-card{
  padding:14px 10px;border-radius:14px;border:2px solid transparent;
  background:var(--bg3);cursor:pointer;text-align:center;
  transition:background .14s ease,border-color .14s ease,transform .12s ease,opacity .12s ease;
}
.type-card:active{transform:scale(.96);opacity:.9;transition:transform .08s ease,opacity .08s ease}
.type-card.on{background:rgba(255,107,53,.08);border-color:var(--sun)}
.type-card-ico{font-size:28px;margin-bottom:4px;line-height:1}
.type-card-lbl{font-size:12px;font-weight:700;color:var(--text)}
.tg-dark .type-card{background:rgba(255,255,255,.07)}
.tg-dark .type-card.on{background:rgba(255,107,53,.16)}

/* ‚ïê‚ïê DURATION GRID ‚ïê‚ïê */
.dur-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:4px}
.dur-btn{
  padding:10px 6px;border-radius:10px;border:2px solid transparent;
  background:var(--bg3);cursor:pointer;text-align:center;
  font-size:12px;font-weight:800;color:var(--hint);font-family:inherit;
  transition:background .13s ease,border-color .13s ease,color .13s ease,transform .12s ease;
}
.dur-btn:active{transform:scale(.95);opacity:.88;transition:transform .08s ease,opacity .08s ease}
.dur-btn.on{background:rgba(255,107,53,.08);border-color:var(--sun);color:var(--sun)}
.tg-dark .dur-btn{background:rgba(255,255,255,.07)}
.tg-dark .dur-btn.on{background:rgba(255,107,53,.18)}

/* ‚ïê‚ïê STEP INDICATOR ‚ïê‚ïê */
.step-ind{display:flex;align-items:center;gap:6px;margin-bottom:20px}
.step-pip{width:8px;height:8px;border-radius:50%;background:var(--bg3);transition:all .25s ease}
.step-pip.on{width:22px;border-radius:4px;background:var(--sun)}
.step-pip.done{background:var(--green);width:8px;border-radius:50%}
.act-step{display:none}
.act-step.active{display:block}
.act-hint{font-size:12px;color:var(--hint);font-weight:500;margin-bottom:16px}

/* ‚ïê‚ïê TOGGLE ROW ‚ïê‚ïê */
.m3-tog-row{
  display:flex;align-items:center;gap:12px;
  padding:13px 14px;background:var(--bg2);
  border-radius:14px;margin-bottom:6px;cursor:pointer;
  transition:opacity .12s;
}
.m3-tog-row:active{opacity:.65;transition:opacity .07s ease}
.m3-tog-ic{font-size:20px;flex-shrink:0;width:26px;text-align:center}
.m3-tog-lbl{flex:1;font-size:14px;font-weight:700}
.tg-dark .m3-tog-row{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.08)}

/* ‚ïê‚ïê WEIGHT CHART push page ‚ïê‚ïê */
.wchart-push-wrap{
  width:100%;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
  padding-bottom:4px;
  isolation:isolate;
  transform:translateZ(0);
  -webkit-transform:translateZ(0);
}
.wchart-push-wrap::-webkit-scrollbar{display:none}

/* ‚ïê‚ïê EMPTY ‚ïê‚ïê */
.empty{text-align:center;padding:40px 20px;animation:empty-fadein .35s ease forwards}
@keyframes empty-fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.empty svg{opacity:.22;margin-bottom:12px}
.empty-t{font-size:15px;font-weight:800;margin-bottom:5px}
.empty-s{font-size:12px;color:var(--hint);font-weight:600}

/* ‚ïê‚ïê DAY SELECTOR ‚ïê‚ïê */
.days-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
.day-btn{
  padding:12px 4px;border-radius:12px;border:2px solid transparent;
  background:var(--bg3);cursor:pointer;text-align:center;
  font-size:12px;font-weight:800;color:var(--hint);font-family:inherit;
  transition:background .13s ease,border-color .13s ease,color .13s ease,opacity .12s ease;
}
.day-btn:active{opacity:.7}
.day-btn.on{background:rgba(255,107,53,.1);border-color:var(--sun);color:var(--sun)}
.tg-dark .day-btn{background:rgba(255,255,255,.07)}
.tg-dark .day-btn.on{background:rgba(255,107,53,.18)}
.day-btn-daily{
  grid-column:1/-1;padding:13px;border-radius:12px;border:2px solid transparent;
  background:var(--bg3);cursor:pointer;text-align:center;
  font-size:13px;font-weight:800;color:var(--hint);font-family:inherit;
  transition:background .13s ease,border-color .13s ease,color .13s ease,opacity .12s ease;margin-bottom:4px;
}
.day-btn-daily:active{opacity:.7}
.day-btn-daily.on{background:rgba(255,107,53,.1);border-color:var(--sun);color:var(--sun)}
.tg-dark .day-btn-daily{background:rgba(255,255,255,.07)}
.tg-dark .day-btn-daily.on{background:rgba(255,107,53,.18)}

/* ‚ïê‚ïê TIME PICKER ‚ïê‚ïê */
.time-picker-row{display:flex;align-items:center;justify-content:center;gap:0}
.time-col{display:flex;flex-direction:column;align-items:center;gap:2px;flex:1}
.time-digit{font-size:42px;font-weight:800;letter-spacing:-.02em;color:var(--text);line-height:1.1;min-width:70px;text-align:center;padding:4px 0}
.time-sep{font-size:38px;font-weight:800;color:var(--text);padding:0 2px;line-height:1;opacity:.4;align-self:center}
.time-arr-btn{
  width:100%;padding:9px 0;background:transparent;border:none;border-radius:9px;
  font-size:20px;color:var(--sun);cursor:pointer;font-family:inherit;
  display:flex;align-items:center;justify-content:center;
  -webkit-tap-highlight-color:transparent;font-weight:800;line-height:1;
}
.time-arr-btn:active{transform:scale(.93);opacity:.7;transition:transform .07s ease,opacity .07s ease}
.tg-dark .time-arr-btn{background:rgba(255,255,255,.08)}

/* ‚ïê‚ïê DARK OVERRIDES ‚ïê‚ïê */
.tg-dark{--bg3:rgba(255,255,255,.07);--brd:rgba(255,255,255,.09);--sh:0 2px 12px rgba(0,0,0,.4)}
.tg-dark .push-page,.tg-dark .pp-hdr{background:var(--bg)}
.tg-dark .t5{color:rgba(255,255,255,.4)}
.tg-dark #nav{background:rgba(20,14,8,.96);border-color:rgba(255,255,255,.1)}
.tg-dark .empty svg{opacity:.15}
.tg-dark .banner::after{opacity:.5}
.stepper-btn{transition:opacity .12s ease,transform .12s ease}
.stepper-btn:active{background:transparent !important;transform:scale(.91);opacity:.65}
.btn-water:active{opacity:.75 !important}

/* ‚ïê‚ïê CLEAR BTN HINT ‚ïê‚ïê */
.clear-hint{font-size:10px;font-weight:600;color:var(--hint);text-align:center;margin-top:6px;padding:0 4px}

/* ‚ïê‚ïê PLAN ADD BTN ‚Äî no longer used, kept for compat ‚ïê‚ïê */
#pl-add-btn-wrap{display:none}

/* ‚ïê‚ïê PLAN PAGE MD3 ‚ïê‚ïê */
#p-plan{
  display:flex;flex-direction:column;
  overflow:hidden !important;
  padding-top:0 !important;
  padding-bottom:0 !important;
}
#p-plan .plan-hdr{
  flex-shrink:0;padding:0 16px 10px;
}
#pl-tasks-outer{
  flex:1;
  overflow:hidden;
  display:flex;flex-direction:column;
  margin:0 14px var(--page-bot);
}
#pl-tasks-container{
  flex:1;
  background:var(--bg2);
  border-radius:20px;
  border:1px solid var(--brd);
  overflow:hidden;
  display:flex;flex-direction:column;
}
.tg-dark #pl-tasks-container{background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.1)}
#pl-tasks-scroll{
  flex:1;overflow-y:auto;overflow-x:hidden;
  -webkit-overflow-scrolling:touch;scrollbar-width:none;
  padding:10px 12px 14px;
}
#pl-tasks-scroll::-webkit-scrollbar{display:none}
.pl-empty{
  flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  padding:30px 16px;
  gap:8px;opacity:.5;
}
.pl-empty svg{opacity:.3}

/* ‚ïê‚ïê PLAN SETTINGS DAYS ‚ïê‚ïê */
.ps-days{display:flex;gap:4px;padding:0;margin-bottom:14px}
.ps-day-btn{
  flex:1;height:38px;border:none;border-radius:10px;
  font-family:inherit;font-size:12px;font-weight:800;
  background:var(--bg3);color:var(--hint);cursor:pointer;
  transition:background .12s,color .12s,transform .12s;
}
.ps-day-btn.on{background:var(--sun);color:#fff}
.ps-day-btn:active{transform:scale(.94)}

/* ‚ïê‚ïê SCANNER ‚ïê‚ïê */
.scanner-viewport{
  width:100%;aspect-ratio:1/1;
  border-radius:24px;overflow:hidden;
  position:relative;background:#000;
  box-shadow:0 8px 32px rgba(0,0,0,.25);
  margin-bottom:16px;
}
#scanner-video{
  width:100%;height:100%;object-fit:cover;display:block;
}
.scanner-overlay{
  position:absolute;inset:0;pointer-events:none;
}
.scanner-line{
  position:absolute;left:20px;right:20px;height:2px;
  background:linear-gradient(90deg,transparent,var(--sun),var(--sun2),var(--sun),transparent);
  border-radius:99px;top:50%;transform:translateY(-50%);
  animation:sc-scan 2.4s ease-in-out infinite;
  box-shadow:0 0 12px rgba(255,107,53,.6);
}
@keyframes sc-scan{0%,100%{top:20%}50%{top:80%}}
.scanner-corner{
  position:absolute;width:28px;height:28px;
  border-color:var(--scan-border,rgba(255,255,255,.7));border-style:solid;border-width:0;
}
.scanner-corner.tl{top:16px;left:16px;border-top-width:3px;border-left-width:3px;border-radius:6px 0 0 0}
.scanner-corner.tr{top:16px;right:16px;border-top-width:3px;border-right-width:3px;border-radius:0 6px 0 0}
.scanner-corner.bl{bottom:16px;left:16px;border-bottom-width:3px;border-left-width:3px;border-radius:0 0 0 6px}
.scanner-corner.br{bottom:16px;right:16px;border-bottom-width:3px;border-right-width:3px;border-radius:0 0 6px 0}
.scanner-viewport.found .scanner-corner{--scan-border:var(--green) !important;}
.scanner-viewport.found .scanner-line{background:linear-gradient(90deg,transparent,var(--green),var(--green),transparent);box-shadow:0 0 12px rgba(82,193,119,.7);animation:none;top:50%}
.scanner-found-card{
  background:var(--bg2);border-radius:18px;padding:16px;
  box-shadow:var(--sh);margin-bottom:16px;
  animation:fadeUp .25s ease;
}
.tg-dark .scanner-found-card{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1)}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
.kbzhu-row{display:flex;gap:6px;margin-top:10px}
.kbzhu-box{flex:1;background:var(--bg3);border-radius:12px;padding:8px;text-align:center}
.kbzhu-v{font-size:16px;font-weight:900;color:var(--text)}
.kbzhu-l{font-size:9px;font-weight:700;color:var(--hint);text-transform:uppercase;letter-spacing:.04em;margin-top:2px}
.scan-ico-btn{
  width:42px;height:42px;border-radius:14px;
  background:rgba(255,107,53,.1);color:var(--sun);
  display:flex;align-items:center;justify-content:center;
  border:none;cursor:pointer;flex-shrink:0;
  transition:background .12s,transform .12s;
}
.scan-ico-btn:active{transform:scale(.93);background:rgba(255,107,53,.18)}
/* Scanner step pages */
.sc-step{display:none}
.sc-step.active{display:block}
.sc-product-hero{
  background:linear-gradient(135deg,rgba(255,107,53,.08),rgba(255,171,64,.04));
  border-radius:20px;padding:20px 16px;margin-bottom:16px;
}
.sc-product-name{font-size:20px;font-weight:900;letter-spacing:-.02em;margin-bottom:4px}
.sc-product-brand{font-size:12px;font-weight:600;color:var(--hint)}
.sc-calc-box{
  background:linear-gradient(135deg,rgba(244,129,74,.1),rgba(255,171,64,.06));
  border-radius:16px;padding:16px;text-align:center;margin-bottom:16px;
}
.sc-calc-kcal{font-size:48px;font-weight:900;color:var(--cal);line-height:1}
.sc-calc-unit{font-size:13px;font-weight:700;color:var(--hint);margin-top:3px}
.sc-calc-macros{display:flex;gap:8px;margin-top:12px}
.sc-calc-macro{flex:1;background:rgba(0,0,0,.04);border-radius:10px;padding:8px;text-align:center}
.tg-dark .sc-calc-macro{background:rgba(255,255,255,.07)}
.sc-calc-macro-v{font-size:15px;font-weight:900}
.sc-calc-macro-l{font-size:9px;font-weight:700;color:var(--hint);text-transform:uppercase;letter-spacing:.04em;margin-top:1px}
/* –ö–ë–ñ–£ track row on calories tab */
.kbzhu-track-row{display:flex;gap:6px;margin-top:10px}
.kbzhu-track-box{flex:1;background:var(--bg2);border-radius:12px;padding:10px 8px;text-align:center;box-shadow:var(--sh)}
.tg-dark .kbzhu-track-box{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.08);box-shadow:none}
.kbzhu-track-v{font-size:17px;font-weight:900}
.kbzhu-track-l{font-size:9px;font-weight:700;color:var(--hint);text-transform:uppercase;letter-spacing:.04em;margin-top:2px}
</style>
</head>
<body>
<div id="root">

<!-- ‚ïê‚ïê SPLASH ‚ïê‚ïê -->
<div id="splash">
  <div class="sp-dots">
    <div class="sp-dot"></div>
    <div class="sp-dot"></div>
    <div class="sp-dot"></div>
  </div>
</div>

<div id="pages">

<!-- ‚ïê‚ïê HOME ‚ïê‚ïê -->
<div class="page active" id="p-home">
<div class="pad" style="display:flex;align-items:flex-start;justify-content:space-between;padding-top:2px">
  <div>
    <div class="t1">–ø—Ä–∏–≤–µ—Ç, <span class="grad" id="h-name">‚Ä¶</span></div>
    <div class="t5" style="margin-top:3px" id="h-date">–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶</div>
  </div>
  <div style="text-align:right;padding-top:4px">
    <div class="t5">–¥–æ –ª–µ—Ç–∞</div>
    <div style="font-size:22px;font-weight:900;color:var(--sun);line-height:1.1" id="h-days">‚Äî</div>
    <div class="t5" id="h-dunit">–¥–Ω–µ–π</div>
  </div>
</div>
<div class="pad gap">
<div class="banner">
  <div style="font-size:13px;font-weight:800;opacity:.88;margin-bottom:2px">–ø—É—Ç—å –∫ –ª–µ—Ç—É</div>
  <div style="font-size:28px;font-weight:900;line-height:1.1"><span id="h-ddays">‚Äî</span> –¥–Ω–µ–π</div>
  <div style="font-size:11px;opacity:.72;font-weight:600;margin-top:3px">—Ç—ã –¥–µ–ª–∞–µ—à—å —ç—Ç–æ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</div>
</div>
</div>
<div class="pad gap">
<div class="card" style="padding:16px 6px 12px">
  <div style="display:flex;justify-content:space-around;align-items:center">
    <div style="text-align:center;cursor:pointer" onclick="navTo('track')">
      <div class="aw">
        <svg width="68" height="68" viewBox="0 0 68 68"><circle cx="34" cy="34" r="26" fill="none" stroke="rgba(78,174,229,.15)" stroke-width="5"/><circle cx="34" cy="34" r="26" fill="none" stroke="var(--water)" stroke-width="5" stroke-linecap="round" stroke-dasharray="163.4" id="arc-w" stroke-dashoffset="163.4" transform="rotate(-90 34 34)" style="transition:stroke-dashoffset .9s cubic-bezier(.34,1.1,.64,1)"/></svg>
        <div class="ai"><div style="font-size:13px;font-weight:900;color:var(--water)" id="arc-wpct">0%</div></div>
      </div>
      <div style="font-size:11px;font-weight:900;margin-top:4px" id="arc-wml">0</div>
      <div class="t5" style="font-size:10px">–º–ª</div>
    </div>
    <div style="text-align:center;cursor:pointer" onclick="navTo('track')">
      <div class="aw">
        <svg width="82" height="82" viewBox="0 0 82 82"><circle cx="41" cy="41" r="33" fill="none" stroke="rgba(244,129,74,.15)" stroke-width="6"/><circle cx="41" cy="41" r="33" fill="none" stroke="var(--cal)" stroke-width="6" stroke-linecap="round" stroke-dasharray="207.3" id="arc-c" stroke-dashoffset="207.3" transform="rotate(-90 41 41)" style="transition:stroke-dashoffset .9s cubic-bezier(.34,1.1,.64,1)"/></svg>
        <div class="ai"><div style="font-size:15px;font-weight:900;color:var(--cal)" id="arc-cpct">0%</div></div>
      </div>
      <div style="font-size:13px;font-weight:900;margin-top:4px" id="arc-cval">0</div>
      <div class="t5" style="font-size:10px">–∫–∫–∞–ª</div>
      <div id="arc-macros" style="margin-top:4px;display:flex;gap:4px;justify-content:center"></div>
    </div>
    <div style="text-align:center;cursor:pointer" onclick="navTo('sleep')">
      <div class="aw">
        <svg width="68" height="68" viewBox="0 0 68 68"><circle cx="34" cy="34" r="26" fill="none" stroke="rgba(139,127,212,.15)" stroke-width="5"/><circle cx="34" cy="34" r="26" fill="none" stroke="var(--sleep)" stroke-width="5" stroke-linecap="round" stroke-dasharray="163.4" id="arc-s" stroke-dashoffset="163.4" transform="rotate(-90 34 34)" style="transition:stroke-dashoffset .9s cubic-bezier(.34,1.1,.64,1)"/></svg>
        <div class="ai"><div style="font-size:13px;font-weight:900;color:var(--sleep)" id="arc-sh">‚Äî</div></div>
      </div>
      <div class="sq" id="arc-sq" style="justify-content:center;margin-top:4px"></div>
      <div class="t5" style="font-size:10px;margin-top:2px">—á–∞—Å–æ–≤</div>
    </div>
  </div>
</div>
</div>
<div class="pad gap">
<div class="card" style="cursor:pointer" onclick="navTo('progress')">
  <div style="display:flex;align-items:center;justify-content:space-between">
    <div>
      <div class="t5" style="margin-bottom:3px">–≤–µ—Å</div>
      <div style="display:flex;align-items:baseline;gap:5px">
        <span style="font-size:26px;font-weight:900;letter-spacing:-.02em" id="h-wcur">‚Äî</span>
        <span class="t5">‚Üí <b style="color:var(--text)" id="h-wgoal">‚Äî</b> –∫–≥</span>
      </div>
    </div>
    <div style="text-align:right">
      <div style="font-size:24px;font-weight:900;color:var(--sun)" id="h-wpct">‚Äî</div>
      <div class="t5">–∫ —Ü–µ–ª–∏</div>
    </div>
  </div>
  <div class="pb gap"><div class="pbf pb-sun" id="h-wbar" style="width:0%"></div></div>
</div>
</div>
<div id="h-plan-sec" style="display:none">
  <div class="sec">—Å–µ–≥–æ–¥–Ω—è</div>
  <div class="pad" id="h-plan-list"></div>
</div>
<div class="pad" id="h-streak-w" style="margin-top:10px;display:none">
  <div style="background:linear-gradient(90deg,rgba(255,107,53,.07),rgba(255,171,64,.04));border-radius:var(--r);padding:12px 14px;display:flex;align-items:center;gap:10px">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="var(--sun)"><path d="M12 2c0 5.5-5 7-5 11a5 5 0 0 0 10 0c0-4-5-5.5-5-11z"/></svg>
    <div>
      <div style="font-size:13px;font-weight:900" id="h-sval">7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
      <div class="t5">—Å–µ—Ä–∏—è –≤–æ–¥—ã</div>
    </div>
  </div>
</div>
<div style="height:8px"></div>
</div>

<!-- ‚ïê‚ïê TRACK ‚ïê‚ïê -->
<div class="page" id="p-track">
<div style="position:sticky;top:0;background:var(--bg);z-index:10;padding:calc(var(--st)+12px) 16px 10px">
  <div class="ttabs">
    <button class="ttab on" id="tt-water" onclick="setTTab('water')">–≤–æ–¥–∞</button>
    <button class="ttab" id="tt-cal" onclick="setTTab('cal')">–∫–∞–ª–æ—Ä–∏–∏</button>
  </div>
</div>
<div id="tt-water-body">
<div class="pad">
<div class="card" style="margin-top:4px;text-align:center;padding:20px 16px;background:linear-gradient(160deg,rgba(78,174,229,.06),rgba(78,174,229,.02))">
  <div class="t5">–≤—ã–ø–∏—Ç–æ —Å–µ–≥–æ–¥–Ω—è</div>
  <div style="font-size:52px;font-weight:900;color:var(--water);line-height:1.1;margin:6px 0" id="w-total">0</div>
  <div class="t5">–∏–∑ <span id="w-goal">2000</span> –º–ª</div>
  <div class="pb" style="margin-top:12px;height:7px"><div class="pbf pb-water" id="w-bar" style="width:0%"></div></div>
  <div id="w-streak" style="margin-top:9px"></div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-top:10px">
  <button class="btn btn-water" onclick="addW(150)">+150 –º–ª</button>
  <button class="btn btn-water" onclick="addW(200)">+200 –º–ª</button>
  <button class="btn btn-water" onclick="addW(250)">+250 –º–ª</button>
  <button class="btn btn-water" onclick="addW(500)">+500 –º–ª</button>
</div>
<button class="btn btn-g" style="margin-top:7px;width:100%;padding:12px" onclick="undoW()">–æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ</button>
<div style="margin-top:10px">
  <button class="btn btn-g" style="width:100%;padding:12px;display:flex;align-items:center;justify-content:space-between" onclick="pushPage('pp-water-hist')">
    <span style="font-size:13px;font-weight:800">–∏—Å—Ç–æ—Ä–∏—è —Å–µ–≥–æ–¥–Ω—è</span>
    <span style="color:var(--hint);font-size:13px">‚Üí</span>
  </button>
</div>
</div>
</div>
<div id="tt-cal-body" style="display:none">
<div class="pad">
<div class="card" style="margin-top:4px;text-align:center;padding:20px 16px">
  <div class="t5">–∫–∞–ª–æ—Ä–∏–π —Å–µ–≥–æ–¥–Ω—è</div>
  <div style="font-size:48px;font-weight:900;color:var(--cal);line-height:1.1;margin:6px 0" id="c-total">0</div>
  <div class="t5">–∏–∑ <span id="c-goal">2000</span> –∫–∫–∞–ª</div>
  <div class="pb" style="margin-top:12px;height:7px"><div class="pbf pb-sun" id="c-bar" style="width:0%"></div></div>
  <div class="kbzhu-track-row" style="margin-top:14px">
    <div class="kbzhu-track-box"><div class="kbzhu-track-v" id="c-prot" style="color:var(--green)">0</div><div class="kbzhu-track-l">–±–µ–ª–∫–∏ –≥</div></div>
    <div class="kbzhu-track-box"><div class="kbzhu-track-v" id="c-fat" style="color:var(--sun)">0</div><div class="kbzhu-track-l">–∂–∏—Ä—ã –≥</div></div>
    <div class="kbzhu-track-box"><div class="kbzhu-track-v" id="c-carb" style="color:var(--sleep)">0</div><div class="kbzhu-track-l">—É–≥–ª–µ–≤. –≥</div></div>
  </div>
</div>
<div class="card gap" style="padding:12px 14px"><div id="c-meals"></div></div>
<button class="btn btn-p gap" onclick="pushPage('pp-cal')">–¥–æ–±–∞–≤–∏—Ç—å –µ–¥—É</button>
</div>
</div>
</div>

<!-- ‚ïê‚ïê PLAN ‚ïê‚ïê -->
<div class="page" id="p-plan">
<div class="plan-hdr" style="padding-top:var(--page-top)">
  <div style="display:flex;align-items:center;justify-content:space-between;padding-bottom:6px">
    <div>
      <div class="t2">–ø–ª–∞–Ω</div>
      <div class="t5" id="pl-date">—Å–µ–≥–æ–¥–Ω—è</div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;cursor:pointer" onclick="openDoneActs()">
      <div style="text-align:right">
        <div style="font-size:26px;font-weight:900;line-height:1;color:var(--sun)" id="pl-cnt">0/0</div>
        <div class="t5" style="font-size:9px">–≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚Üí</div>
      </div>
      <svg width="44" height="44" viewBox="0 0 52 52">
        <circle cx="26" cy="26" r="20" fill="none" stroke="rgba(255,107,53,.12)" stroke-width="4.5"/>
        <circle cx="26" cy="26" r="20" fill="none" stroke="var(--sun)" stroke-width="4.5" stroke-linecap="round" stroke-dasharray="125.7" id="pl-ring" stroke-dashoffset="125.7" transform="rotate(-90 26 26)" style="transition:stroke-dashoffset .6s cubic-bezier(.34,1.1,.64,1)"/>
      </svg>
    </div>
  </div>
  <div style="font-size:9px;font-weight:700;color:var(--hint);text-align:center;letter-spacing:.04em;opacity:.7;padding-bottom:8px">—É–¥–µ—Ä–∂–∏ –∫–∞—Ä—Ç–æ—á–∫—É —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å</div>
</div>
<div id="pl-tasks-outer">
  <div id="pl-tasks-container">
    <div id="pl-tasks-scroll">
      <div id="pl-list"></div>
      <div id="pl-empty" style="display:none" class="pl-empty">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18M9 16l2 2 4-4"/></svg>
        <div style="font-size:13px;font-weight:700">–Ω–µ—Ç –∑–∞–¥–∞—á –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê SLEEP ‚ïê‚ïê -->
<div class="page" id="p-sleep">
<div class="pad">
  <div class="t2" style="margin-bottom:1px">—Å–æ–Ω</div>
  <div class="t5">—Ö–æ—Ä–æ—à–∏–π —Å–æ–Ω ‚Äî –æ—Å–Ω–æ–≤–∞ –≤—Å–µ–≥–æ</div>
</div>
<div class="pad gap">
<div class="card">
  <div class="t5" style="margin-bottom:7px">–ø—Ä–æ—à–ª–∞—è –Ω–æ—á—å</div>
  <div style="display:flex;align-items:center;gap:16px">
    <div>
      <div style="font-size:48px;font-weight:900;line-height:1;color:var(--sleep)" id="sl-h">‚Äî</div>
      <div class="t5" style="margin-top:2px">—á–∞—Å–æ–≤</div>
    </div>
    <div>
      <div style="font-size:34px" id="sl-qico">‚Äî</div>
      <div class="sq" id="sl-dots" style="margin-top:4px"></div>
    </div>
  </div>
</div>
</div>
<button class="btn btn-p" style="margin:10px 16px 0;width:calc(100% - 32px)" onclick="pushPage('pp-sleep')">–∑–∞–ø–∏—Å–∞—Ç—å —Å–æ–Ω</button>
<div class="pad" style="margin-top:10px">
  <button class="btn btn-g" style="width:100%;padding:12px;display:flex;align-items:center;justify-content:space-between" onclick="pushPage('pp-sleep-hist')">
    <span style="font-size:13px;font-weight:800">–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –Ω–æ—á–µ–π</span>
    <span style="color:var(--hint);font-size:13px">‚Üí</span>
  </button>
</div>
<div class="sec">—Å—Ä–µ–¥–Ω–µ–µ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
<div class="pad sb-row">
  <div class="sbox"><div class="sv" id="sl-avg-h" style="color:var(--sleep)">‚Äî</div><div class="sl">—á–∞—Å–æ–≤</div></div>
  <div class="sbox"><div class="sv" id="sl-avg-q">‚Äî</div><div class="sl">–∫–∞—á–µ—Å—Ç–≤–æ</div></div>
</div>
<div style="height:8px"></div>
</div>

<!-- ‚ïê‚ïê PROGRESS ‚ïê‚ïê -->
<div class="page" id="p-progress">
<div class="pad">
  <div class="t2" style="margin-bottom:1px">–ø—Ä–æ–≥—Ä–µ—Å—Å</div>
  <div class="t5">—Ç–≤–æ–π –ø—É—Ç—å –∫ –ª–µ—Ç—É</div>
</div>
<div class="pad gap">
<div class="card">
  <div class="t5" style="margin-bottom:5px">–ø—Ä–æ–≥—Ä–µ—Å—Å –≤–µ—Å–∞</div>
  <div style="display:flex;align-items:flex-end;gap:7px;margin-bottom:3px">
    <span style="font-size:38px;font-weight:900;line-height:1" id="pr-wcur">‚Äî</span>
    <span class="t5" style="padding-bottom:4px">–∫–≥ ¬∑ —Ü–µ–ª—å <b style="color:var(--text)" id="pr-wgoal">‚Äî</b></span>
  </div>
  <div class="t5" id="pr-winfo" style="margin-bottom:8px"></div>
  <div class="pb" style="height:8px"><div class="pbf pb-sun" id="pr-wbar" style="width:0%;height:100%"></div></div>
  <div style="display:flex;justify-content:space-between;margin-top:4px">
    <span class="t5" id="pr-wstart">‚Äî</span>
    <span style="font-size:11px;font-weight:900;color:var(--sun)" id="pr-wpct">0%</span>
    <span class="t5" id="pr-wgoal2">‚Äî</span>
  </div>
  <div id="pr-forecast" style="margin-top:7px;font-size:11px;font-weight:800;color:var(--green)"></div>
</div>
</div>
<div class="pad gap">
  <button class="btn btn-g" style="width:100%;padding:14px 16px;font-size:14px;border-radius:14px;display:flex;align-items:center;justify-content:space-between" onclick="pushPage('pp-weight-chart')">
    <span style="display:flex;align-items:center;gap:8px">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M7 16l4-4 4 4 4-6"/></svg>
      <span style="font-weight:800">–¥–∏–Ω–∞–º–∏–∫–∞ –≤–µ—Å–∞</span>
    </span>
    <span style="color:var(--hint)">–æ—Ç–∫—Ä—ã—Ç—å ‚Üí</span>
  </button>
</div>
<div class="sec">—ç—Ç–∞ –Ω–µ–¥–µ–ª—è</div>
<div class="pad sb-row">
  <div class="sbox"><div class="sv" style="color:var(--water)" id="pw-water">‚Äî</div><div class="sl">–≤–æ–¥–∞ –º–ª</div></div>
  <div class="sbox"><div class="sv" style="color:var(--cal)" id="pw-cal">‚Äî</div><div class="sl">–∫–∫–∞–ª</div></div>
  <div class="sbox"><div class="sv" style="color:var(--sleep)" id="pw-sleep">‚Äî</div><div class="sl">—Å–æ–Ω —á</div></div>
</div>
<div style="display:flex;gap:8px;margin:10px 16px 0">
  <button class="btn btn-p" style="flex:1" onclick="pushPage('pp-weight')">–∑–∞–ø–∏—Å–∞—Ç—å –≤–µ—Å</button>
  <button class="btn btn-g" style="padding:15px 16px;font-size:13px;border-radius:14px" onclick="pushPage('pp-history')">–∏—Å—Ç–æ—Ä–∏—è ‚Üí</button>
</div>
<div style="height:8px"></div>
</div>

<!-- ‚ïê‚ïê PROFILE ‚ïê‚ïê -->
<div class="page" id="p-profile">
<div style="display:flex;align-items:center;gap:14px;padding:4px 16px 0">
  <div class="pav" id="pf-av">–ê</div>
  <div>
    <div class="t2" id="pf-name">‚Äî</div>
    <div class="t5" id="pf-meta" style="margin-top:2px">‚Äî</div>
  </div>
</div>
<div id="pf-bmi-row" style="margin-top:12px;padding:0 16px;display:none">
  <div class="sb-row">
    <div class="sbox"><div class="sv" id="pf-bmi">‚Äî</div><div class="sl">–ò–ú–¢</div></div>
    <div class="sbox"><div class="sv" id="pf-ideal">‚Äî</div><div class="sl">–∏–¥–µ–∞–ª –∫–≥</div></div>
    <div class="sbox"><div class="sv" id="pf-bmr">‚Äî</div><div class="sl">BMR</div></div>
  </div>
</div>
<div class="sec">–Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
<div class="pad">
<div class="card">
  <div class="lt" onclick="pushPage('pp-pdata')">
    <div class="lt-ic"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg></div>
    <span class="lt-lbl">–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è</span>
    <span class="lt-val" id="pf-pname">‚Äî</span>
    <svg class="lt-chev" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
  </div>
  <div class="lt" onclick="pushPage('pp-start-weight')">
    <div class="lt-ic">‚öñÔ∏è</div>
    <span class="lt-lbl">–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–µ—Å –∏ —Ü–µ–ª—å</span>
    <span class="lt-val" id="pf-sw">‚Äî</span>
    <svg class="lt-chev" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
  </div>
  <div class="lt" style="padding-bottom:0;border:none" onclick="pushPage('pp-goals')">
    <div class="lt-ic"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="4"/><path d="M12 3v2M12 19v2M3 12h2M19 12h2"/></svg></div>
    <span class="lt-lbl">–º–æ–∏ —Ü–µ–ª–∏</span>
    <span class="lt-val"><span id="pf-gw">‚Äî</span></span>
    <svg class="lt-chev" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
  </div>
  <div class="lt" style="padding-bottom:0;border:none" onclick="pushPage('pp-plan-settings')">
    <div class="lt-ic"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18M9 16l2 2 4-4"/></svg></div>
    <span class="lt-lbl">–ø–ª–∞–Ω –ø–æ –¥–Ω—è–º</span>
    <span class="lt-val">—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span>
    <svg class="lt-chev" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
  </div>
</div>
</div>
<div class="pad" style="margin-top:10px">
  <button class="btn btn-danger" style="width:100%;padding:14px" onclick="resetAllData()">üóë —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
  <div class="clear-hint">—É–¥–∞–ª–∏—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–≤—Å–µ–≥–¥–∞</div>
</div>
<div style="text-align:center;padding:16px 0 8px"><div class="t5">letify ¬∑ ver 4.3</div></div>
<div style="height:8px"></div>
</div>

</div><!-- /pages -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PUSH PAGES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- PP: –ù–∞—á–∞–ª—å–Ω—ã–π –≤–µ—Å –∏ —Ü–µ–ª—å -->
<div class="push-page" id="pp-start-weight">
  <div class="pp-hdr">
    <button class="pp-back" onclick="popPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M11 6l-6 6 6 6"/></svg></button>
    <div><div class="pp-title">–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–µ—Å</div><div class="pp-subtitle">—Ç–æ—á–∫–∞ –æ—Ç—Å—á—ë—Ç–∞ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</div></div>
  </div>
  <div class="pp-body">
    <div class="big-val-card">
      <div class="big-val"><span id="sw-int">80</span><span style="font-size:28px;color:var(--hint)">.</span><span id="sw-dec">0</span></div>
      <div class="big-val-unit">–∫–≥ ¬∑ –Ω–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞</div>
    </div>
    <div class="m3-sec">–∫–∏–ª–æ–≥—Ä–∞–º–º—ã</div>
    <div class="m3-card" style="padding:8px">
      <div class="stepper-wrap">
        <button class="stepper-btn" onclick="stepSW('int',-1)">‚àí</button>
        <div class="stepper-val" id="sw-int-disp">80</div>
        <button class="stepper-btn" onclick="stepSW('int',1)">+</button>
      </div>
    </div>
    <div class="m3-sec">–¥–µ—Å—è—Ç—ã–µ</div>
    <div class="m3-card" style="padding:8px">
      <div class="stepper-wrap">
        <button class="stepper-btn" onclick="stepSW('dec',-1)">‚àí</button>
        <div class="stepper-val" id="sw-dec-disp">.0</div>
        <button class="stepper-btn" onclick="stepSW('dec',1)">+</button>
      </div>
    </div>
    <div class="m3-sec">–º–æ—è —Ü–µ–ª—å</div>
    <div class="m3-card" style="padding:10px">
      <div class="m3-seg" id="seg-goal-type" style="margin-bottom:0">
        <button class="m3-seg-btn on" onclick="setGoalType('lose')" data-gt="lose">üìâ –ø–æ—Ö—É–¥–µ–Ω–∏–µ</button>
        <button class="m3-seg-btn" onclick="setGoalType('gain')" data-gt="gain">üìà –Ω–∞–±–æ—Ä –º–∞—Å—Å—ã</button>
      </div>
    </div>
    <div style="font-size:12px;color:var(--hint);text-align:center;font-weight:600;margin-bottom:20px" id="sw-type-hint">–ø—Ä–æ–≥—Ä–µ—Å—Å —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –ø–æ—Ç–µ—Ä—è –≤–µ—Å–∞</div>
    <button class="btn btn-p" onclick="saveStartWeight()">—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- PP: –ó–∞–ø–∏—Å–∞—Ç—å –≤–µ—Å -->
<div class="push-page" id="pp-weight">
  <div class="pp-hdr">
    <button class="pp-back" onclick="popPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M11 6l-6 6 6 6"/></svg></button>
    <div><div class="pp-title">–∑–∞–ø–∏—Å–∞—Ç—å –≤–µ—Å</div><div class="pp-subtitle" style="margin-top:1px">—Ç–µ–∫—É—â–∏–π –≤–µ—Å –≤ –∫–∏–ª–æ–≥—Ä–∞–º–º–∞—Ö</div></div>
  </div>
  <div class="pp-body">
    <div class="big-val-card">
      <div class="big-val"><span id="wt-int">70</span><span style="font-size:28px;color:var(--hint)">.</span><span id="wt-dec">0</span></div>
      <div class="big-val-unit">–∫–≥</div>
    </div>
    <div class="m3-sec">–∫–∏–ª–æ–≥—Ä–∞–º–º—ã</div>
    <div class="m3-card" style="padding:8px">
      <div class="stepper-wrap">
        <button class="stepper-btn" onclick="stepW('int',-1)">‚àí</button>
        <div class="stepper-val" id="wt-int-disp">70</div>
        <button class="stepper-btn" onclick="stepW('int',1)">+</button>
      </div>
    </div>
    <div class="m3-sec">–¥–µ—Å—è—Ç—ã–µ</div>
    <div class="m3-card" style="padding:8px">
      <div class="stepper-wrap">
        <button class="stepper-btn" onclick="stepW('dec',-1)">‚àí</button>
        <div class="stepper-val" id="wt-dec-disp">.0</div>
        <button class="stepper-btn" onclick="stepW('dec',1)">+</button>
      </div>
    </div>
    <button class="btn btn-p" style="margin-top:20px" onclick="submitWeight()">—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Å</button>
  </div>
</div>

<!-- PP: –ó–∞–ø–∏—Å–∞—Ç—å —Å–æ–Ω -->
<div class="push-page" id="pp-sleep">
  <div class="pp-hdr">
    <button class="pp-back" onclick="popPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M11 6l-6 6 6 6"/></svg></button>
    <div><div class="pp-title">–∑–∞–ø–∏—Å–∞—Ç—å —Å–æ–Ω</div><div class="pp-subtitle" style="margin-top:1px">—Å–∫–æ–ª—å–∫–æ —Å–ø–∞–ª –ø—Ä–æ—à–ª–æ–π –Ω–æ—á—å—é?</div></div>
  </div>
  <div class="pp-body">
    <div class="big-val-card" style="background:linear-gradient(135deg,rgba(139,127,212,.08),rgba(139,127,212,.03))">
      <div class="big-val" style="color:var(--sleep)"><span id="sl-val-disp">8</span><span style="font-size:28px;color:var(--hint)">.0</span></div>
      <div class="big-val-unit">—á–∞—Å–æ–≤</div>
    </div>
    <div class="m3-sec">—á–∞—Å–æ–≤ —Å–Ω–∞</div>
    <div class="m3-card" style="padding:8px">
      <div class="stepper-wrap">
        <button class="stepper-btn" style="color:var(--sleep)" onclick="stepSl('h',-1)">‚àí</button>
        <div class="stepper-val" id="sl-h-disp" style="color:var(--sleep)">8</div>
        <button class="stepper-btn" style="color:var(--sleep)" onclick="stepSl('h',1)">+</button>
      </div>
    </div>
    <div class="m3-sec">–º–∏–Ω—É—Ç—ã</div>
    <div class="m3-card" style="padding:10px">
      <div class="m3-seg" style="margin-bottom:0">
        <button class="m3-seg-btn on" id="sl-m0" onclick="setSleepMin(0)">:00</button>
        <button class="m3-seg-btn" id="sl-m30" onclick="setSleepMin(30)">:30</button>
      </div>
    </div>
    <div class="m3-sec">–∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞</div>
    <div class="m3-card" style="padding:10px">
      <div class="m3-seg m3-seg-emoji" id="seg-sleepq" style="margin-bottom:0">
        <button class="m3-seg-btn" onclick="setSleepQ(1)" data-q="1">üò´</button>
        <button class="m3-seg-btn" onclick="setSleepQ(2)" data-q="2">üò¥</button>
        <button class="m3-seg-btn on" onclick="setSleepQ(3)" data-q="3">üòë</button>
        <button class="m3-seg-btn" onclick="setSleepQ(4)" data-q="4">üôÇ</button>
        <button class="m3-seg-btn" onclick="setSleepQ(5)" data-q="5">üåü</button>
      </div>
    </div>
    <button class="btn btn-p" style="margin-top:20px" onclick="submitSleep()">—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–Ω</button>
  </div>
</div>

<!-- PP: –î–æ–±–∞–≤–∏—Ç—å –µ–¥—É -->
<div class="push-page" id="pp-cal">
  <div class="pp-hdr">
    <button class="pp-back" onclick="calBackOrPop()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M11 6l-6 6 6 6"/></svg></button>
    <div style="flex:1">
      <div class="step-ind"><div class="step-pip on" id="cp1"></div><div class="step-pip" id="cp2"></div></div>
      <div class="pp-title" id="cal-step-title">–Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞</div>
    </div>
    <button class="scan-ico-btn" onclick="pushPage('pp-scanner')" title="—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2"/><rect x="7" y="7" width="10" height="10" rx="1"/></svg>
    </button>
  </div>
  <div class="pp-body">
    <div class="act-step active" id="cal-s1">
      <div class="act-hint">–∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –±–ª—é–¥–æ?</div>
      <div class="m3-card" style="padding:16px 14px;margin-bottom:0">
        <div class="m3-field" style="margin-bottom:0">
          <div class="m3-label">–±–ª—é–¥–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
          <input class="m3-input" id="inp-cal-desc" type="text" placeholder="–≥—Ä–µ—á–∫–∞, –∫—É—Ä–∏—Ü–∞, —Å—É–ø‚Ä¶" autocomplete="off" style="font-size:17px">
        </div>
      </div>
      <button class="btn btn-p" style="margin-top:20px" onclick="calStepNext()">–¥–∞–ª–µ–µ ‚Üí</button>
    </div>
    <div class="act-step" id="cal-s2">
      <div class="big-val-card" style="background:linear-gradient(135deg,rgba(244,129,74,.08),rgba(244,129,74,.03))">
        <div class="big-val" style="color:var(--cal)" id="cal-preview">500</div>
        <div class="big-val-unit">–∫–∫–∞–ª</div>
      </div>
      <div class="m3-sec">–∫–∞–ª–æ—Ä–∏–π</div>
      <div class="m3-card" style="padding:8px">
        <div class="stepper-wrap">
          <button class="stepper-btn" style="color:var(--cal)" onclick="stepCal(-50)">‚àí</button>
          <div class="stepper-val" style="color:var(--cal)" id="cal-step-disp">500</div>
          <button class="stepper-btn" style="color:var(--cal)" onclick="stepCal(50)">+</button>
        </div>
      </div>
      <div class="dur-grid" style="margin-bottom:10px">
        <button class="dur-btn" onclick="setCalVal(100)">100</button>
        <button class="dur-btn" onclick="setCalVal(200)">200</button>
        <button class="dur-btn" onclick="setCalVal(350)">350</button>
        <button class="dur-btn" onclick="setCalVal(500)">500</button>
        <button class="dur-btn" onclick="setCalVal(650)">650</button>
        <button class="dur-btn" onclick="setCalVal(800)">800</button>
        <button class="dur-btn" onclick="setCalVal(1000)">1000</button>
        <button class="dur-btn" onclick="setCalVal(1200)">1200</button>
      </div>
      <div class="m3-sec">–ø—Ä–∏—ë–º –ø–∏—â–∏</div>
      <div class="m3-seg" id="seg-meal" style="margin-bottom:0">
        <button class="m3-seg-btn on" onclick="setMeal('breakfast')" data-m="breakfast">–∑–∞–≤—Ç—Ä–∞–∫</button>
        <button class="m3-seg-btn" onclick="setMeal('lunch')" data-m="lunch">–æ–±–µ–¥</button>
        <button class="m3-seg-btn" onclick="setMeal('dinner')" data-m="dinner">—É–∂–∏–Ω</button>
        <button class="m3-seg-btn" onclick="setMeal('snack')" data-m="snack">–ø–µ—Ä–µ–∫—É—Å</button>
      </div>
      <div style="margin-top:14px">
        <div onclick="toggleCalMacros()" style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg3);border-radius:12px;cursor:pointer">
          <span style="font-size:13px;font-weight:700;color:var(--hint)">+ —É–∫–∞–∑–∞—Ç—å –ö–ë–ñ–£ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
          <span id="cal-macros-arrow" style="color:var(--hint);font-size:16px;transition:transform .2s">‚ñº</span>
        </div>
        <div id="cal-macros-wrap" style="display:none;margin-top:8px">
          <div class="m3-card">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div class="m3-field" style="margin-bottom:0"><div class="m3-label">–±–µ–ª–∫–∏, –≥</div><input class="m3-input num" id="inp-prot" type="number" inputmode="decimal" step="0.1" placeholder="0"></div>
              <div class="m3-field" style="margin-bottom:0"><div class="m3-label">–∂–∏—Ä—ã, –≥</div><input class="m3-input num" id="inp-fat" type="number" inputmode="decimal" step="0.1" placeholder="0"></div>
              <div class="m3-field" style="margin-bottom:0"><div class="m3-label">—É–≥–ª–µ–≤–æ–¥—ã, –≥</div><input class="m3-input num" id="inp-carb" type="number" inputmode="decimal" step="0.1" placeholder="0"></div>
              <div style="display:flex;align-items:center;padding:8px;background:var(--bg3);border-radius:12px;font-size:11px;font-weight:600;color:var(--hint)">–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ</div>
            </div>
          </div>
        </div>
      </div>
      <button class="btn btn-p" style="margin-top:20px" onclick="submitCal()">–¥–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- PP: –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è -->
<div class="push-page" id="pp-pdata">
  <div class="pp-hdr">
    <button class="pp-back" onclick="popPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M11 6l-6 6 6 6"/></svg></button>
    <div><div class="pp-title">–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è</div></div>
  </div>
  <div class="pp-body">
    <div class="m3-card">
      <div class="m3-field"><div class="m3-label">–∏–º—è</div><input class="m3-input" id="inp-pname" type="text" placeholder="–¥–∞–Ω–µ—á–∫–∞"></div>
      <div class="m3-field"><div class="m3-label">—Ä–æ—Å—Ç, —Å–º</div><input class="m3-input num" id="inp-height" type="number" inputmode="numeric" min="100" max="250" placeholder="175"></div>
      <div class="m3-field"><div class="m3-label">–≤–æ–∑—Ä–∞—Å—Ç</div><input class="m3-input num" id="inp-age" type="number" inputmode="numeric" min="10" max="100" placeholder="25"></div>
    </div>
    <div class="m3-sec">–ø–æ–ª</div>
    <div class="m3-seg" id="seg-gender">
      <button class="m3-seg-btn on" onclick="setGender('male')" data-g="male">‚ôÇ –º—É–∂—Å–∫–æ–π</button>
      <button class="m3-seg-btn" onclick="setGender('female')" data-g="female">‚ôÄ –∂–µ–Ω—Å–∫–∏–π</button>
    </div>
  </div>
</div>

<!-- PP: –¶–µ–ª–∏ -->
<div class="push-page" id="pp-goals">
  <div class="pp-hdr">
    <button class="pp-back" onclick="popPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M11 6l-6 6 6 6"/></svg></button>
    <div><div class="pp-title">–º–æ–∏ —Ü–µ–ª–∏</div></div>
  </div>
  <div class="pp-body">
    <div class="m3-card">
      <div class="m3-field"><div class="m3-label">—Ü–µ–ª–µ–≤–æ–π –≤–µ—Å, –∫–≥</div><input class="m3-input num" id="inp-gw" type="number" inputmode="decimal" step="0.5" placeholder="70"></div>
      <div class="m3-field"><div class="m3-label">–Ω–æ—Ä–º–∞ –≤–æ–¥—ã, –º–ª</div><input class="m3-input num" id="inp-gwat" type="number" inputmode="numeric" step="100" placeholder="2000"></div>
      <div class="m3-field"><div class="m3-label">–Ω–æ—Ä–º–∞ –∫–∞–ª–æ—Ä–∏–π</div><input class="m3-input num" id="inp-gcal" type="number" inputmode="numeric" step="50" placeholder="2000"></div>
    </div>
  </div>
</div>

<!-- PP: –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
<div class="push-page" id="pp-act">
  <div class="pp-hdr">
    <button class="pp-back" id="pp-act-back" onclick="actBackOrPop()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M11 6l-6 6 6 6"/></svg></button>
    <div style="flex:1">
      <div class="step-ind">
        <div class="step-pip on" id="sp1"></div>
        <div class="step-pip" id="sp2"></div>
        <div class="step-pip" id="sp3"></div>
        <div class="step-pip" id="sp4"></div>
      </div>
      <div class="pp-title" id="act-step-title">–Ω–∞–∑–≤–∞–Ω–∏–µ</div>
    </div>
  </div>
  <div class="pp-body">
    <div class="act-step active" id="act-s1">
      <div class="act-hint">–∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å?</div>
      <div class="m3-card" style="padding:10px 12px;margin-bottom:0">
        <div class="m3-field" style="margin-bottom:0">
          <div class="m3-label">–Ω–∞–∑–≤–∞–Ω–∏–µ</div>
          <input class="m3-input" id="inp-aname" type="text" placeholder="–ø—Ä–æ–±–µ–∂–∫–∞, –π–æ–≥–∞, –∑–∞–ª‚Ä¶" autocomplete="off">
        </div>
      </div>
      <div style="margin:14px 0 8px;font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--hint)">–∏–ª–∏ –≤—ã–±–µ—Ä–∏</div>
      <div class="type-grid" id="act-quick">
        <div class="type-card on" onclick="actQuick('–ø—Ä–æ–±–µ–∂–∫–∞','run',this)"><div class="type-card-ico">üèÉ</div><div class="type-card-lbl">–ø—Ä–æ–±–µ–∂–∫–∞</div></div>
        <div class="type-card" onclick="actQuick('–∑–∞–ª','gym',this)"><div class="type-card-ico">üí™</div><div class="type-card-lbl">–∑–∞–ª</div></div>
        <div class="type-card" onclick="actQuick('–π–æ–≥–∞','yoga',this)"><div class="type-card-ico">üßò</div><div class="type-card-lbl">–π–æ–≥–∞</div></div>
        <div class="type-card" onclick="actQuick('—Ö–æ–¥—å–±–∞','walk',this)"><div class="type-card-ico">üö∂</div><div class="type-card-lbl">—Ö–æ–¥—å–±–∞</div></div>
        <div class="type-card" onclick="actQuick('–≤–µ–ª–æ—Å–∏–ø–µ–¥','bike',this)"><div class="type-card-ico">üö¥</div><div class="type-card-lbl">–≤–µ–ª–æ—Å–∏–ø–µ–¥</div></div>
        <div class="type-card" onclick="actQuick('–¥—Ä—É–≥–æ–µ','other',this)"><div class="type-card-ico">‚ú®</div><div class="type-card-lbl">–¥—Ä—É–≥–æ–µ</div></div>
      </div>
    </div>
    <div class="act-step" id="act-s2">
      <div class="act-hint">–≤—ã–±–µ—Ä–∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞</div>
      <div style="margin-bottom:8px;font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--hint)">–≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</div>
      <div class="m3-card" style="padding:6px 8px;background:var(--bg3) !important;box-shadow:none">
        <div class="time-picker-row">
          <div class="time-col">
            <button class="time-arr-btn" onclick="stepTime('sh',-1)">‚ñ≤</button>
            <div class="time-digit" id="time-h-disp">08</div>
            <button class="time-arr-btn" onclick="stepTime('sh',1)">‚ñº</button>
          </div>
          <div class="time-sep">:</div>
          <div class="time-col">
            <button class="time-arr-btn" onclick="stepTime('sm',-1)">‚ñ≤</button>
            <div class="time-digit" id="time-m-disp">00</div>
            <button class="time-arr-btn" onclick="stepTime('sm',1)">‚ñº</button>
          </div>
        </div>
      </div>
      <input type="hidden" id="inp-atime" value="08:00">
      <div style="margin:14px 0 8px;font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--hint)">–≤—Ä–µ–º—è –∫–æ–Ω—Ü–∞</div>
      <div class="m3-card" style="padding:6px 8px;background:var(--bg3) !important;box-shadow:none">
        <div class="time-picker-row">
          <div class="time-col">
            <button class="time-arr-btn" onclick="stepTime('eh',-1)">‚ñ≤</button>
            <div class="time-digit" id="time-eh-disp">09</div>
            <button class="time-arr-btn" onclick="stepTime('eh',1)">‚ñº</button>
          </div>
          <div class="time-sep">:</div>
          <div class="time-col">
            <button class="time-arr-btn" onclick="stepTime('em',-1)">‚ñ≤</button>
            <div class="time-digit" id="time-em-disp">00</div>
            <button class="time-arr-btn" onclick="stepTime('em',1)">‚ñº</button>
          </div>
        </div>
      </div>
      <div id="act-dur-display" style="text-align:center;margin-top:10px;font-size:13px;font-weight:700;color:var(--hint)">–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 60 –º–∏–Ω</div>
    </div>
    <div class="act-step" id="act-s3">
      <div class="act-hint">–≤ –∫–∞–∫–∏–µ –¥–Ω–∏ –ø–æ–≤—Ç–æ—Ä—è—Ç—å?</div>
      <button class="day-btn-daily on" id="day-btn-daily" onclick="toggleDayDaily()">–µ–∂–µ–¥–Ω–µ–≤–Ω–æ</button>
      <div class="days-grid" id="days-grid">
        <button class="day-btn" onclick="toggleDay(1,this)" data-day="1">–ø–Ω</button>
        <button class="day-btn" onclick="toggleDay(2,this)" data-day="2">–≤—Ç</button>
        <button class="day-btn" onclick="toggleDay(3,this)" data-day="3">—Å—Ä</button>
        <button class="day-btn" onclick="toggleDay(4,this)" data-day="4">—á—Ç</button>
        <button class="day-btn" onclick="toggleDay(5,this)" data-day="5">–ø—Ç</button>
        <button class="day-btn" onclick="toggleDay(6,this)" data-day="6">—Å–±</button>
        <button class="day-btn" onclick="toggleDay(0,this)" data-day="0">–≤—Å</button>
      </div>
    </div>
    <div class="act-step" id="act-s4">
      <div class="act-hint">–ø—Ä–æ–≤–µ—Ä—å –∏ –¥–æ–±–∞–≤—å –≤ –ø–ª–∞–Ω</div>
      <div style="text-align:center;padding:16px 0 12px">
        <div id="act-confirm-ico" style="font-size:60px;margin-bottom:12px">üèÉ</div>
        <div id="act-confirm-name" style="font-size:24px;font-weight:900;letter-spacing:-.02em;margin-bottom:6px">‚Äî</div>
        <div id="act-confirm-time" style="font-size:15px;color:var(--hint);font-weight:700">‚Äî</div>
        <div id="act-confirm-days" style="font-size:12px;color:var(--sun);font-weight:700;margin-top:4px">‚Äî</div>
      </div>
      <div class="m3-card" style="padding:14px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <span style="font-size:14px;font-weight:700">–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</span>
          <div class="tog on" id="tog-act-rem" onclick="this.classList.toggle('on');this.classList.toggle('off')"></div>
        </div>
      </div>
    </div>
    <button class="btn btn-p" id="act-next-btn" onclick="actStepNext()" style="margin-top:20px">–¥–∞–ª–µ–µ ‚Üí</button>
  </div>
</div>

<!-- PP: –ò—Å—Ç–æ—Ä–∏—è -->
<div class="push-page" id="pp-history">
  <div class="pp-hdr">
    <button class="pp-back" onclick="popPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M11 6l-6 6 6 6"/></svg></button>
    <div><div class="pp-title">–∏—Å—Ç–æ—Ä–∏—è</div><div class="pp-subtitle">–≤–µ—Å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div></div>
  </div>
  <div class="pp-body">
    <div class="m3-sec">–∏—Å—Ç–æ—Ä–∏—è –≤–µ—Å–∞</div>
    <div class="m3-card"><div id="pp-whist" style="padding:2px 0"></div></div>
    <button class="btn btn-danger" style="margin-top:4px" onclick="clearWeightHistory()">üóë –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤–µ—Å–∞</button>
    <div class="clear-hint">–¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞</div>
    <div class="m3-sec" style="margin-top:8px">–∑–∞ –≤—Å—ë –≤—Ä–µ–º—è</div>
    <div class="sb-row">
      <div class="sbox"><div class="sv grad" id="pp-at-t">0</div><div class="sl">—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div></div>
      <div class="sbox"><div class="sv grad" id="pp-at-w">0</div><div class="sl">–≤–æ–¥—ã –ª</div></div>
      <div class="sbox"><div class="sv grad" id="pp-at-s">0</div><div class="sl">—Å–µ—Ä–∏—è –¥–Ω</div></div>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- PP: –ò—Å—Ç–æ—Ä–∏—è –≤–æ–¥—ã -->
<div class="push-page" id="pp-water-hist">
  <div class="pp-hdr">
    <button class="pp-back" onclick="popPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M11 6l-6 6 6 6"/></svg></button>
    <div><div class="pp-title">–∏—Å—Ç–æ—Ä–∏—è –≤–æ–¥—ã</div><div class="pp-subtitle">—Å–µ–≥–æ–¥–Ω—è</div></div>
  </div>
  <div class="pp-body">
    <div class="m3-card" style="padding:10px 12px">
      <div id="wh-entries">
        <div style="text-align:center;padding:20px;color:var(--hint);font-size:13px;font-weight:600">–ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω–æ</div>
      </div>
    </div>
    <button class="btn btn-danger" style="margin-top:10px" onclick="clearWaterHistory()">üóë –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤–æ–¥—ã</button>
    <div class="clear-hint">—Å–±—Ä–æ—Å–∏—Ç –≤—Å—é –≤–æ–¥—É –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
  </div>
</div>

<!-- PP: –ò—Å—Ç–æ—Ä–∏—è —Å–Ω–∞ -->
<div class="push-page" id="pp-sleep-hist">
  <div class="pp-hdr">
    <button class="pp-back" onclick="popPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M11 6l-6 6 6 6"/></svg></button>
    <div><div class="pp-title">–∏—Å—Ç–æ—Ä–∏—è —Å–Ω–∞</div><div class="pp-subtitle">–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –Ω–æ—á–µ–π</div></div>
  </div>
  <div class="pp-body">
    <div class="m3-card" style="padding:10px 12px">
      <div id="slh-entries">
        <div style="text-align:center;padding:20px;color:var(--hint);font-size:13px;font-weight:600">–Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>
      </div>
    </div>
    <button class="btn btn-danger" style="margin-top:10px" onclick="clearSleepHistory()">üóë –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–Ω–∞</button>
    <div class="clear-hint">–¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞</div>
    <div class="sec" style="padding-top:16px">—Å—Ä–µ–¥–Ω–µ–µ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
    <div class="sb-row">
      <div class="sbox"><div class="sv" id="slh-avg-h" style="color:var(--sleep)">‚Äî</div><div class="sl">—á–∞—Å–æ–≤</div></div>
      <div class="sbox"><div class="sv" id="slh-avg-q">‚Äî</div><div class="sl">–∫–∞—á–µ—Å—Ç–≤–æ</div></div>
    </div>
  </div>
</div>

<!-- PP: –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ -->
<div class="push-page" id="pp-done-acts">
  <div class="pp-hdr">
    <button class="pp-back" onclick="popPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M11 6l-6 6 6 6"/></svg></button>
    <div><div class="pp-title">–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</div><div class="pp-subtitle">–∑–∞–¥–∞—á–∏ —Å–µ–≥–æ–¥–Ω—è</div></div>
  </div>
  <div class="pp-body">
    <div class="m3-card" style="padding:0;overflow:hidden">
      <div id="done-acts-list" style="padding:10px 12px">
        <div style="text-align:center;padding:20px;color:var(--hint);font-size:13px;font-weight:600">–Ω–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</div>
      </div>
    </div>
  </div>
</div>

<!-- PP: –ì—Ä–∞—Ñ–∏–∫ –≤–µ—Å–∞ -->
<div class="push-page" id="pp-weight-chart">
  <div class="pp-hdr">
    <button class="pp-back" onclick="popPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M11 6l-6 6 6 6"/></svg></button>
    <div><div class="pp-title">–¥–∏–Ω–∞–º–∏–∫–∞ –≤–µ—Å–∞</div><div class="pp-subtitle" id="wc-sub">–∏—Å—Ç–æ—Ä–∏—è</div></div>
  </div>
  <div class="pp-body" style="padding:12px 12px calc(var(--sb)+24px)">
    <div class="wchart-push-wrap" id="wchart-container">
      <div id="wchart-svg-wrap"></div>
    </div>
    <div style="margin-top:16px" id="wc-stat-list"></div>
  </div>
</div>

<!-- PP: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞–Ω–∞ –ø–æ –¥–Ω—è–º -->
<div class="push-page" id="pp-plan-settings">
  <div class="pp-hdr">
    <button class="pp-back" onclick="popPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M11 6l-6 6 6 6"/></svg></button>
    <div><div class="pp-title">–ø–ª–∞–Ω</div><div class="pp-subtitle">—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –¥–Ω—è–º</div></div>
  </div>
  <div class="pp-body">
    <div class="ps-days" id="ps-days-bar">
      <button class="ps-day-btn on" data-dow="1" onclick="psDaySelect(1,this)">–ø–Ω</button>
      <button class="ps-day-btn" data-dow="2" onclick="psDaySelect(2,this)">–≤—Ç</button>
      <button class="ps-day-btn" data-dow="3" onclick="psDaySelect(3,this)">—Å—Ä</button>
      <button class="ps-day-btn" data-dow="4" onclick="psDaySelect(4,this)">—á—Ç</button>
      <button class="ps-day-btn" data-dow="5" onclick="psDaySelect(5,this)">–ø—Ç</button>
      <button class="ps-day-btn" data-dow="6" onclick="psDaySelect(6,this)">—Å–±</button>
      <button class="ps-day-btn" data-dow="0" onclick="psDaySelect(0,this)">–≤—Å</button>
    </div>
    <div style="font-size:11px;font-weight:700;color:var(--hint);margin-bottom:8px;letter-spacing:.04em" id="ps-day-label">–∑–∞–¥–∞—á–∏ –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</div>
    <div id="ps-tasks-list">
      <div style="text-align:center;padding:24px;color:var(--hint);font-size:13px;font-weight:600">–Ω–µ—Ç –∑–∞–¥–∞—á</div>
    </div>
    <button class="btn btn-p" style="margin-top:16px" onclick="popPage();pushPage('pp-act')">+ –¥–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</button>
  </div>
</div>

<!-- PP: –°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ -->
<div class="push-page" id="pp-scanner">
  <div class="pp-hdr">
    <button class="pp-back" onclick="scannerBack()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M11 6l-6 6 6 6"/></svg></button>
    <div style="flex:1">
      <div class="step-ind">
        <div class="step-pip on" id="scp1"></div>
        <div class="step-pip" id="scp2"></div>
        <div class="step-pip" id="scp3"></div>
      </div>
      <div class="pp-title" id="sc-step-title">—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
    </div>
  </div>
  <div class="pp-body" style="padding:16px">

    <!-- Step 1: Camera -->
    <div class="sc-step active" id="sc-s1">
      <div class="scanner-viewport" id="scanner-viewport">
        <video id="scanner-video" autoplay playsinline muted></video>
        <div class="scanner-overlay">
          <div class="scanner-corner tl"></div>
          <div class="scanner-corner tr"></div>
          <div class="scanner-corner bl"></div>
          <div class="scanner-corner br"></div>
          <div class="scanner-line"></div>
        </div>
        <div id="scanner-status" style="position:absolute;bottom:14px;left:0;right:0;text-align:center;font-size:12px;font-weight:700;color:rgba(255,255,255,.85);text-shadow:0 1px 4px rgba(0,0,0,.7);letter-spacing:.02em">–Ω–∞–≤–µ–¥–∏ –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥</div>
      </div>
      <div style="text-align:center;padding:8px 0 4px">
        <div style="font-size:13px;font-weight:600;color:var(--hint)">–∏–ª–∏ –≤–≤–µ–¥–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤—Ä—É—á–Ω—É—é</div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <input class="m3-input" id="inp-barcode-manual" type="text" inputmode="numeric" placeholder="4600000000000" style="flex:1;padding:14px 14px 14px" autocomplete="off">
          <button class="btn btn-p" style="padding:14px 18px;flex-shrink:0;font-size:14px" onclick="manualBarcode()">‚Üí</button>
        </div>
      </div>
      <div id="scanner-not-found" style="display:none;text-align:center;padding:16px 0">
        <div style="font-size:32px;margin-bottom:8px">üîç</div>
        <div style="font-size:15px;font-weight:800;margin-bottom:4px">–ø—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>
        <div class="t5" style="margin-bottom:16px">—à—Ç—Ä–∏—Ö–∫–æ–¥: <span id="sc-barcode-val">‚Äî</span></div>
        <button class="btn btn-g" style="width:100%;padding:13px" onclick="scannerRetry()">–ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
      </div>
    </div>

    <!-- Step 2: Product info + grams -->
    <div class="sc-step" id="sc-s2">
      <div class="sc-product-hero">
        <div class="sc-product-name" id="sc-name">‚Äî</div>
        <div class="sc-product-brand" id="sc-brand"></div>
        <div class="kbzhu-row" style="margin-top:12px">
          <div class="kbzhu-box"><div class="kbzhu-v" id="sc-kcal" style="color:var(--cal)">‚Äî</div><div class="kbzhu-l">–∫–∫–∞–ª/100–≥</div></div>
          <div class="kbzhu-box"><div class="kbzhu-v" id="sc-prot" style="color:var(--green)">‚Äî</div><div class="kbzhu-l">–±–µ–ª–∫–∏</div></div>
          <div class="kbzhu-box"><div class="kbzhu-v" id="sc-fat" style="color:var(--sun)">‚Äî</div><div class="kbzhu-l">–∂–∏—Ä—ã</div></div>
          <div class="kbzhu-box"><div class="kbzhu-v" id="sc-carb" style="color:var(--sleep)">‚Äî</div><div class="kbzhu-l">—É–≥–ª–µ–≤.</div></div>
        </div>
      </div>
      <div class="m3-sec">–≤–µ—Å –ø–æ—Ä—Ü–∏–∏</div>
      <div class="m3-card" style="padding:8px;margin-bottom:12px">
        <div class="stepper-wrap">
          <button class="stepper-btn" onclick="stepScGrams(-10)">‚àí</button>
          <div class="stepper-val" id="sc-grams-disp">100<span class="unit">–≥</span></div>
          <button class="stepper-btn" onclick="stepScGrams(10)">+</button>
        </div>
      </div>
      <div class="sc-calc-box" id="sc-calc-box">
        <div class="sc-calc-kcal" id="sc-calc-kcal">‚Äî</div>
        <div class="sc-calc-unit">–∫–∫–∞–ª –∑–∞ <span id="sc-grams-label">100</span>–≥</div>
        <div class="sc-calc-macros">
          <div class="sc-calc-macro"><div class="sc-calc-macro-v" id="sc-calc-prot" style="color:var(--green)">‚Äî</div><div class="sc-calc-macro-l">–±–µ–ª–∫–∏ –≥</div></div>
          <div class="sc-calc-macro"><div class="sc-calc-macro-v" id="sc-calc-fat" style="color:var(--sun)">‚Äî</div><div class="sc-calc-macro-l">–∂–∏—Ä—ã –≥</div></div>
          <div class="sc-calc-macro"><div class="sc-calc-macro-v" id="sc-calc-carb" style="color:var(--sleep)">‚Äî</div><div class="sc-calc-macro-l">—É–≥–ª–µ–≤. –≥</div></div>
        </div>
      </div>
      <button class="btn btn-p" style="margin-top:4px;width:100%" onclick="scGotoMeal()">–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Üí</button>
    </div>

    <!-- Step 3: Meal type selection -->
    <div class="sc-step" id="sc-s3">
      <div style="text-align:center;padding:12px 0 20px">
        <div style="font-size:40px;margin-bottom:10px">üçΩÔ∏è</div>
        <div style="font-size:18px;font-weight:900;margin-bottom:4px" id="sc-confirm-name">‚Äî</div>
        <div style="font-size:14px;font-weight:700;color:var(--cal)" id="sc-confirm-kcal">‚Äî</div>
      </div>
      <div class="m3-sec">–ø—Ä–∏—ë–º –ø–∏—â–∏</div>
      <div class="type-grid" style="grid-template-columns:1fr 1fr">
        <div class="type-card on" id="scm-breakfast" onclick="setScMeal('breakfast',this)"><div class="type-card-ico">üåÖ</div><div class="type-card-lbl">–∑–∞–≤—Ç—Ä–∞–∫</div></div>
        <div class="type-card" id="scm-lunch" onclick="setScMeal('lunch',this)"><div class="type-card-ico">‚òÄÔ∏è</div><div class="type-card-lbl">–æ–±–µ–¥</div></div>
        <div class="type-card" id="scm-dinner" onclick="setScMeal('dinner',this)"><div class="type-card-ico">üåô</div><div class="type-card-lbl">—É–∂–∏–Ω</div></div>
        <div class="type-card" id="scm-snack" onclick="setScMeal('snack',this)"><div class="type-card-ico">üçé</div><div class="type-card-lbl">–ø–µ—Ä–µ–∫—É—Å</div></div>
      </div>
      <button class="btn btn-p" style="margin-top:20px;width:100%" onclick="submitScanned()">–¥–æ–±–∞–≤–∏—Ç—å ‚úì</button>
    </div>

  </div>
</div>

<!-- NAV ‚Äî no dots, icon centered -->
<nav id="nav">
  <div class="nt on" id="nt-home" onclick="navTo('home')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9.5z"/><path d="M9 21V12h6v9"/></svg>
  </div>
  <div class="nt" id="nt-track" onclick="navTo('track')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="3" width="16" height="18" rx="2"/><path d="M8 7h8M8 11h8M8 15h5"/></svg>
  </div>
  <div class="nt" id="nt-plan" onclick="navTo('plan')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18M9 16l2 2 4-4"/></svg>
  </div>
  <div class="nt" id="nt-sleep" onclick="navTo('sleep')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
  </div>
  <div class="nt" id="nt-progress" onclick="navTo('progress')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M7 16l4-4 4 4 4-6"/></svg>
  </div>
  <div class="nt" id="nt-profile" onclick="navTo('profile')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>
  </div>
</nav>

</div><!-- /root -->

<script>
/* ‚ïê‚ïê TG INIT ‚ïê‚ïê */
const tg=window.Telegram?.WebApp;
if(tg){
  document.body.classList.add('tg-env');
  tg.ready();tg.expand();
  if(typeof tg.requestFullscreen==='function')tg.requestFullscreen();
  if(typeof tg.disableVerticalSwipes==='function')tg.disableVerticalSwipes();
  if(typeof tg.setHeaderColor==='function')tg.setHeaderColor('bg_color');
  if(typeof tg.setBackgroundColor==='function')tg.setBackgroundColor('bg_color');
  tg.onEvent('themeChanged',applyTheme);
  tg.onEvent('viewportChanged',_applySA);
  tg.onEvent('safeAreaChanged',_applySA);
  tg.onEvent('fullscreenChanged',_applySA);
  setTimeout(_applySA,80);setTimeout(_applySA,400);
}
function _applySA(){
  const saTop=Math.max(tg?.safeAreaInset?.top??0,0);
  const csaTop=Math.max(tg?.contentSafeAreaInset?.top??0,0);
  const top=Math.min(saTop+csaTop,120);
  const saBot=Math.max(tg?.safeAreaInset?.bottom??0,0);
  const csaBot=Math.max(tg?.contentSafeAreaInset?.bottom??0,0);
  const bot=Math.min(saBot+csaBot,80);
  document.documentElement.style.setProperty('--st',top+'px');
  document.documentElement.style.setProperty('--sb',bot+'px');
  if(!navHidden){const nav=document.getElementById('nav');if(nav)nav.style.bottom=(12+bot)+'px';}
}
function applyTheme(){
  const p=tg?.themeParams||{};
  const dark=tg?.colorScheme==='dark'||window.matchMedia?.('(prefers-color-scheme:dark)').matches;
  document.body.classList.toggle('tg-dark',dark);
  if(dark){
    const bg=p.bg_color||'#111111';
    document.documentElement.style.setProperty('--bg',bg);
    document.documentElement.style.setProperty('--bg2',bg);
    document.documentElement.style.setProperty('--text',p.text_color||'#ffffff');
    document.documentElement.style.setProperty('--hint',p.hint_color||'#708499');
  }else{
    const m={'--bg':p.bg_color,'--bg2':p.secondary_bg_color||p.bg_color,'--text':p.text_color,'--hint':p.hint_color};
    for(const[k,v]of Object.entries(m))if(v)document.documentElement.style.setProperty(k,v);
  }
}
applyTheme();

/* ‚ïê‚ïê DATA ‚ïê‚ïê */
const API_BASE='https://letify-production.up.railway.app';
const tgUser=tg?.initDataUnsafe?.user;
const UID=tgUser?.id||null;
const TODAY=new Date().toLocaleDateString('en-CA');

/* localStorage helpers */
const lsGet=k=>{try{const r=localStorage.getItem('lf2_'+k);return r?JSON.parse(r):null}catch{return null}};
const lsSet=(k,v)=>{try{localStorage.setItem('lf2_'+k,JSON.stringify(v))}catch{}};

let C={
  user:{name:'‚Ä¶',height:0,age:0,start_weight:0,goal_weight:0,water_goal:2000,cal_goal:2000,gender:'male',goal_type:'lose'},
  settings:{show_weight:1,show_water:1,show_calories:1,show_sleep:1},
  water:{total:0,entries:[],streak:0},calories:{},macros:{prot:0,fat:0,carb:0},
  weight_log:[],sleep_log:[],acts_today:[],products:[]
};

async function loadData(){
  if(!UID){_demo();return;}
  try{
    const r=await fetch(`${API_BASE}/api/data?uid=${UID}`);
    if(!r.ok)throw 0;
    const d=await r.json();
    C.user=d.user||C.user;C.settings=d.settings||C.settings;
    C.water=d.water||C.water;C.calories=d.calories||C.calories;
    C.macros=d.macros||lsGet('macros_'+TODAY)||{prot:0,fat:0,carb:0};
    C.weight_log=d.weight_log||[];C.sleep_log=d.sleep_log||[];
    C.acts_today=d.acts_today||[];C.products=d.products||[];
    // Always restore start_weight/goal_type from localStorage ‚Äî server may not store them
    const localUser=lsGet('user_sw');
    if(localUser?.start_weight>0&&(!C.user.start_weight||C.user.start_weight===0)){
      C.user.start_weight=localUser.start_weight;
    }
    if(localUser?.goal_type)C.user.goal_type=localUser.goal_type||'lose';
  }catch{_demo();}
}

function _demo(){
  if(!lsGet('ds')){
    lsSet('user',{name:tgUser?.first_name||'–¥–∞–Ω–µ—á–∫–∞',height:175,age:27,start_weight:85,goal_weight:75,water_goal:2500,cal_goal:2000,gender:'male',goal_type:'lose'});
    const now=new Date(),wl=[],sl=[];
    for(let i=13;i>=0;i--){const d=new Date(now);d.setDate(d.getDate()-i);wl.push({weight:+(85-((13-i)*.25)+(Math.random()-.5)*.3).toFixed(1),logged_at:d.toLocaleDateString('en-CA')});}
    for(let i=6;i>=0;i--){const d=new Date(now);d.setDate(d.getDate()-i);sl.push({hours:+(6.5+Math.random()*2).toFixed(1),quality:3+Math.floor(Math.random()*3),logged_at:d.toLocaleDateString('en-CA')});}
    lsSet('wlog',wl);lsSet('slog',sl);
    lsSet('wd_'+TODAY,{total:1350,entries:[250,200,150,250,200,150,150]});
    lsSet('cd_'+TODAY,{breakfast:420,lunch:680,dinner:0,snack:185,other:0});lsSet('streak',7);
    lsSet('acts_'+TODAY,[
      {id:1,name:'–ø—Ä–æ–±–µ–∂–∫–∞',type:'run',scheduled_at:'2024-01-01T07:00',duration:30,completed:0},
      {id:2,name:'–∑–∞–ª',type:'gym',scheduled_at:'2024-01-01T18:30',duration:60,completed:0},
      {id:3,name:'–π–æ–≥–∞',type:'yoga',scheduled_at:'2024-01-01T21:00',duration:25,completed:0}
    ]);lsSet('ds',1);
  }
  const u=lsGet('user')||{};
  const wd=lsGet('wd_'+TODAY)||{total:0,entries:[]};
  const cd=lsGet('cd_'+TODAY)||{};
  C.user={...{name:'–¥–∞–Ω–µ—á–∫–∞',height:0,age:0,start_weight:0,goal_weight:0,water_goal:2000,cal_goal:2000,gender:'male',goal_type:'lose'},...u};
  // user_sw is the authoritative source for start_weight (survives reloads & server overwrites)
  const sw=lsGet('user_sw');
  if(sw?.start_weight>0)C.user.start_weight=sw.start_weight;
  if(sw?.goal_type)C.user.goal_type=sw.goal_type;
  C.settings={show_weight:1,show_water:1,show_calories:1,show_sleep:1};
  C.water={total:wd.total||0,entries:wd.entries||[],streak:lsGet('streak')||0};
  C.calories=cd;
  C.macros=lsGet('macros_'+TODAY)||{prot:0,fat:0,carb:0};
  C.weight_log=lsGet('wlog')||[];
  C.sleep_log=lsGet('slog')||[];
  C.acts_today=lsGet('acts_'+TODAY)||[];
}

async function apiPost(path,body){
  if(!UID)return;
  try{await fetch(`${API_BASE}${path}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uid:UID,...body})});}catch{}
}
async function reload(){
  await loadData();
  if(_completingMap.size>0)return;
  const rMap={home:renderHome,track:()=>renderTrack(trackTab),plan:renderPlan,sleep:renderSleep,progress:renderProgress,profile:renderProfile};
  rMap[curTab]?.();
}

const gU=()=>C.user;
const gWL=()=>C.weight_log.map(r=>({weight:r.weight,logged_at:(r.logged_at||'').slice(0,10)})).sort((a,b)=>(a.logged_at||'').localeCompare(b.logged_at||''));
const gSL=()=>C.sleep_log.map(r=>({hours:r.hours,quality:r.quality,logged_at:(r.logged_at||'').slice(0,10)}));
const gWD=()=>C.water;
const gCD=()=>C.calories;
const gActs=()=>C.acts_today.map(a=>({...a,time:(a.scheduled_at||'').slice(11,16)||'00:00',completed:!!a.completed}));
const gStreak=()=>C.water.streak||0;
const totalCal=()=>Object.values(gCD()).reduce((a,b)=>a+b,0);

/* ‚ïê‚ïê NAVIGATION ‚ïê‚ïê */
const TABS=['home','track','plan','sleep','progress','profile'];
let curTab='home',trackTab='water',navHidden=false;

function navTo(tab){
  if(tab===curTab&&!curPushPage)return;
  if(curPushPage)popPage(false);
  curTab=tab;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const pg=document.getElementById('p-'+tab);
  if(pg){pg.scrollTop=0;pg.classList.add('active');}
  TABS.forEach(t=>{document.getElementById('nt-'+t)?.classList.toggle('on',t===tab);});
  const renders={home:renderHome,track:()=>renderTrack(trackTab),plan:renderPlan,sleep:renderSleep,progress:renderProgress,profile:renderProfile};
  renders[tab]?.();
  tg?.HapticFeedback?.selectionChanged();
}
function setTTab(t){
  trackTab=t;
  ['water','cal'].forEach(k=>{
    document.getElementById('tt-'+k)?.classList.toggle('on',k===t);
    const b=document.getElementById('tt-'+k+'-body');if(b)b.style.display=k===t?'':'none';
  });
  renderTrack(t);
}

/* ‚ïê‚ïê PUSH PAGES ‚ïê‚ïê */
let curPushPage=null;
function pushPage(id){
  curPushPage=id;navHidden=true;
  document.getElementById('nav')?.classList.add('gone');
  const pp=document.getElementById(id);
  if(pp){pp.classList.add('open');pp.scrollTop=0;const body=pp.querySelector('.pp-body');if(body)body.scrollTop=0;}
  _populatePP(id);
  if(tg?.BackButton){tg.BackButton.show();tg.BackButton.onClick(popPage);}
  tg?.HapticFeedback?.impactOccurred('light');
}
function popPage(doRender=true){
  if(!curPushPage)return;
  if(curPushPage==='pp-pdata')_saveProfileSilent();
  if(curPushPage==='pp-goals')_saveGoalsSilent();
  if(curPushPage==='pp-scanner')stopScanner();
  if(curPushPage==='pp-weight-chart'){
    const wrap=document.getElementById('wchart-svg-wrap');
    if(wrap)wrap.innerHTML='';
  }
  const pp=document.getElementById(curPushPage);
  if(pp){
    pp.style.opacity='0';pp.style.transform='translateY(10px) translateZ(0)';
    setTimeout(()=>{pp.style.transition='none';pp.classList.remove('open');pp.style.opacity='';pp.style.transform='';setTimeout(()=>{pp.style.transition='';},10);},200);
  }
  curPushPage=null;navHidden=false;
  document.getElementById('nav')?.classList.remove('gone');
  const sb=Math.min(Math.max(tg?.safeAreaInset?.bottom??0,0),80);
  const nav=document.getElementById('nav');if(nav)nav.style.bottom=(12+sb)+'px';
  if(tg?.BackButton){tg.BackButton.hide();tg.BackButton.offClick(popPage);}
  if(doRender&&_completingMap.size===0){const renders={home:renderHome,track:()=>renderTrack(trackTab),plan:renderPlan,sleep:renderSleep,progress:renderProgress,profile:renderProfile};renders[curTab]?.();}
}

function _populatePP(id){
  const u=gU();
  if(id==='pp-weight-chart'){_populateWeightChart();}
  if(id==='pp-start-weight'){
    const sw=u.start_weight&&u.start_weight>0?u.start_weight:80;
    _swInt=Math.floor(sw);_swDec=Math.round((sw-Math.floor(sw))*10);
    _goalType=u.goal_type||'lose';
    _updateSWDisplay();
    document.querySelectorAll('#seg-goal-type .m3-seg-btn').forEach(b=>b.classList.toggle('on',b.dataset.gt===_goalType));
    _updateGoalTypeHint();
  }
  if(id==='pp-weight'){
    const wl=gWL();const iw=wl.length?wl[wl.length-1].weight:u.start_weight||70;
    _wtInt=Math.round(Math.floor(iw));_wtDec=Math.round((iw-Math.floor(iw))*10);
    _updateWeightDisplay();
  }
  if(id==='pp-sleep'){
    const sl=gSL();const ih=sl.length?sl[sl.length-1].hours:8;
    _slH=Math.floor(ih);_slMin=ih%1>=.5?30:0;_sleepQ=3;
    _updateSleepDisplay();
    document.querySelectorAll('#seg-sleepq .m3-seg-btn').forEach(b=>b.classList.toggle('on',+b.dataset.q===3));
  }
  if(id==='pp-cal'){
    _calVal=500;_mealType='breakfast';_calStep=1;
    document.getElementById('inp-cal-desc').value='';
    document.getElementById('cal-s1')?.classList.add('active');
    document.getElementById('cal-s2')?.classList.remove('active');
    const t=document.getElementById('cal-step-title');if(t)t.textContent='–Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞';
    const p1=document.getElementById('cp1'),p2=document.getElementById('cp2');
    if(p1){p1.classList.add('on');p1.classList.remove('done');}
    if(p2)p2.classList.remove('on');
    _updateCalDisplay();
    document.querySelectorAll('#seg-meal .m3-seg-btn').forEach(b=>b.classList.toggle('on',b.dataset.m==='breakfast'));
    document.querySelectorAll('#cal-s2 .dur-grid .dur-btn').forEach(b=>b.classList.remove('on'));
  }
  if(id==='pp-pdata'){
    const ni=document.getElementById('inp-pname');if(ni)ni.value=u.name||'';
    const hi=document.getElementById('inp-height');if(hi)hi.value=u.height||'';
    const ai=document.getElementById('inp-age');if(ai)ai.value=u.age||'';
    _gender=u.gender||'male';
    document.querySelectorAll('#seg-gender .m3-seg-btn').forEach(b=>b.classList.toggle('on',b.dataset.g===_gender));
  }
  if(id==='pp-goals'){
    const gi=document.getElementById('inp-gw');if(gi)gi.value=u.goal_weight||'';
    const wi=document.getElementById('inp-gwat');if(wi)wi.value=u.water_goal||2000;
    const ci=document.getElementById('inp-gcal');if(ci)ci.value=u.cal_goal||2000;
  }
  if(id==='pp-history'){
    const wl=gWL(),wd=gWD(),acts=gActs();
    const l20=[...wl].reverse().slice(0,20);
    const HH=(eid,v)=>{const el=document.getElementById(eid);if(el)el.innerHTML=v;};
    const emptyMsg='<div style="text-align:center;padding:16px;color:var(--hint);font-size:13px;font-weight:600">–Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
    HH('pp-whist',l20.length?l20.map((e,i)=>{
      const prev=l20[i+1];
      const diff=prev?+(e.weight-prev.weight).toFixed(1):0;
      const diffHtml=diff?('<div class="hr-diff '+(diff<0?'d-neg':'d-pos')+'">'+(diff>0?'+':'')+diff+'</div>'):'<div></div>';
      return '<div class="hr"><div class="hr-d">'+fmtD(e.logged_at)+'</div><div class="hr-v">'+e.weight.toFixed(1)+' –∫–≥</div>'+diffHtml+'</div>';
    }).join(''):emptyMsg);
    T('pp-at-t',acts.filter(a=>a.completed).length);
    T('pp-at-w',+((wd.total||0)/1000).toFixed(1));
    T('pp-at-s',gStreak());
  }
  if(id==='pp-act'){
    actStep=1;_actType='run';_actDur=45;_timeH=8;_timeM=0;_timeEH=9;_timeEM=0;_actDays=[];
    const ni=document.getElementById('inp-aname');if(ni)ni.value='–ø—Ä–æ–±–µ–∂–∫–∞';
    document.querySelectorAll('#act-quick .type-card').forEach((c,i)=>c.classList.toggle('on',i===0));
    document.getElementById('day-btn-daily')?.classList.add('on');
    document.querySelectorAll('#days-grid .day-btn').forEach(b=>b.classList.remove('on'));
    _updateTimeDisplay();_renderActStep();
  }
  if(id==='pp-water-hist'){
    const wd=gWD();const entries=wd.entries||[];
    const el=document.getElementById('wh-entries');
    if(el){
      if(!entries.length){el.innerHTML='<div style="text-align:center;padding:20px;color:var(--hint);font-size:13px;font-weight:600">–ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω–æ</div>';}
      else{el.innerHTML=[...entries].reverse().map((e,i)=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--brd)${i===entries.length-1?';border-bottom:none':''}">
        <div style="display:flex;align-items:center;gap:8px"><div style="width:32px;height:32px;border-radius:10px;background:rgba(78,174,229,.1);display:flex;align-items:center;justify-content:center;font-size:14px">üíß</div><span style="font-size:14px;font-weight:800;color:var(--water)">+${e} –º–ª</span></div>
        <span class="t5">—Å—Ç–∞–∫–∞–Ω ${entries.length-i}</span></div>`).join('');}
    }
  }
  if(id==='pp-sleep-hist'){
    const sl=gSL();const l7=sl.slice(-7).reverse();
    const el=document.getElementById('slh-entries');
    if(el){
      if(!l7.length){el.innerHTML='<div style="text-align:center;padding:20px;color:var(--hint);font-size:13px;font-weight:600">–Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';}
      else{el.innerHTML=l7.map(e=>`<div class="hr"><div class="hr-d">${fmtD(e.logged_at)}</div><div style="display:flex;align-items:center;gap:7px;flex:1"><div class="hr-v">${e.hours.toFixed(1)} —á</div><div class="sq">${Array.from({length:5},(_,i)=>`<div class="sqd${i<e.quality?' on':''}"></div>`).join('')}</div></div><div style="font-size:16px">${qIco(e.quality)}</div></div>`).join('');}
    }
    if(l7.length){
      T('slh-avg-h',+(l7.reduce((a,b)=>a+b.hours,0)/l7.length).toFixed(1));
      T('slh-avg-q',qIco(Math.round(l7.reduce((a,b)=>a+(b.quality||3),0)/l7.length))+' '+(l7.reduce((a,b)=>a+(b.quality||3),0)/l7.length).toFixed(1));
    }
  }
  if(id==='pp-done-acts'){
    const acts=gActs().filter(a=>a.completed);
    const el=document.getElementById('done-acts-list');
    if(el){
      if(!acts.length){el.innerHTML='<div style="text-align:center;padding:20px;color:var(--hint);font-size:13px;font-weight:600">–Ω–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</div>';}
      else{el.innerHTML=acts.map(a=>{
        const col=ACT_COL[a.type]||'#FF9800';
        return`<div class="ac done" style="margin-bottom:8px"><div class="ac-ico" style="background:${col}18">‚úÖ</div><div class="ac-body"><div class="ac-name done-text">${a.name}</div><div class="ac-sub">${fmtRange(a)} ¬∑ ${a.duration} –º–∏–Ω</div></div><span class="pill p-ok">‚úì</span></div>`;
      }).join('');}
    }
  }
  if(id==='pp-plan-settings'){
    const todayJs=new Date().getDay(); // 0=–≤—Å,1=–ø–Ω...
    _psDow=todayJs===0?0:todayJs;
    document.querySelectorAll('.ps-day-btn').forEach(b=>b.classList.toggle('on',+b.dataset.dow===_psDow));
    T('ps-day-label','–∑–∞–¥–∞—á–∏ –Ω–∞ '+(_dowLabels[_psDow]||'–¥–µ–Ω—å'));
    _renderPsTasksList();
  }
  if(id==='pp-scanner'){
    _scFoundProduct=null;
    _scGrams=100;_scMealType='breakfast';
    _scStep=1;
    // Reset all steps
    [1,2,3].forEach(i=>{
      document.getElementById('sc-s'+i)?.classList.toggle('active',i===1);
      const pip=document.getElementById('scp'+i);
      if(pip){pip.classList.toggle('on',i===1);pip.classList.remove('done');}
    });
    T('sc-step-title','—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ');
    const nf=$('scanner-not-found');if(nf)nf.style.display='none';
    const vp=$('scanner-viewport');if(vp)vp.classList.remove('found');
    const st=$('scanner-status');if(st)st.textContent='–Ω–∞–≤–µ–¥–∏ –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥';
    // Reset meal type selection
    ['breakfast','lunch','dinner','snack'].forEach(x=>{document.getElementById('scm-'+x)?.classList.toggle('on',x==='breakfast');});
    setTimeout(startScanner,200);
  }
}

/* ‚ïê‚ïê START WEIGHT STEPPER ‚ïê‚ïê */
let _swInt=80,_swDec=0,_goalType='lose';
function _updateSWDisplay(){
  const A=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
  A('sw-int',_swInt);A('sw-dec',_swDec);
  A('sw-int-disp',_swInt);A('sw-dec-disp','.'+_swDec);
}
function _updateGoalTypeHint(){
  const el=document.getElementById('sw-type-hint');
  if(el)el.textContent=_goalType==='lose'?'–ø—Ä–æ–≥—Ä–µ—Å—Å —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –ø–æ—Ç–µ—Ä—è –≤–µ—Å–∞':'–ø—Ä–æ–≥—Ä–µ—Å—Å —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –Ω–∞–±–æ—Ä –≤–µ—Å–∞';
}
function stepSW(part,dir){
  if(part==='int')_swInt=Math.max(30,Math.min(250,_swInt+dir));
  else _swDec=(_swDec+dir+10)%10;
  _updateSWDisplay();tg?.HapticFeedback?.selectionChanged();
}
function setGoalType(gt){
  _goalType=gt;
  document.querySelectorAll('#seg-goal-type .m3-seg-btn').forEach(b=>b.classList.toggle('on',b.dataset.gt===gt));
  _updateGoalTypeHint();
  tg?.HapticFeedback?.selectionChanged();
}
function saveStartWeight(){
  const sw=_swInt+_swDec/10;
  if(sw<30||sw>300){toast('–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å');return;}
  C.user={...C.user,start_weight:sw,goal_type:_goalType};
  // Always persist start_weight to localStorage ‚Äî used as fallback even in API mode
  lsSet('user_sw',{start_weight:sw,goal_type:_goalType});
  if(!UID)lsSet('user',C.user);
  popPage();
  renderProfile();renderProgress();renderHome();
  toast('–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–µ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  tg?.HapticFeedback?.notificationOccurred('success');
  apiPost('/api/profile',{start_weight:sw,goal_type:_goalType});
}

/* ‚ïê‚ïê WEIGHT STEPPER ‚ïê‚ïê */
let _wtInt=70,_wtDec=0;
function _updateWeightDisplay(){
  const A=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
  A('wt-int',_wtInt);A('wt-dec',_wtDec);A('wt-int-disp',_wtInt);A('wt-dec-disp','.'+_wtDec);
}
function stepW(part,dir){
  if(part==='int')_wtInt=Math.max(30,Math.min(250,_wtInt+dir));
  else _wtDec=(_wtDec+dir+10)%10;
  _updateWeightDisplay();tg?.HapticFeedback?.selectionChanged();
}

/* ‚ïê‚ïê SLEEP STEPPER ‚ïê‚ïê */
let _slH=8,_slMin=0,_sleepQ=3;
function _updateSleepDisplay(){
  const e=document.getElementById('sl-val-disp');if(e)e.textContent=_slH;
  const hd=document.getElementById('sl-h-disp');if(hd)hd.textContent=_slH;
  const m0=document.getElementById('sl-m0'),m30=document.getElementById('sl-m30');
  if(m0){m0.classList.toggle('on',_slMin===0);m0.classList.toggle('off',_slMin!==0);}
  if(m30){m30.classList.toggle('on',_slMin===30);m30.classList.toggle('off',_slMin!==30);}
}
function stepSl(part,dir){
  if(part==='h')_slH=Math.max(1,Math.min(20,_slH+dir));
  _updateSleepDisplay();tg?.HapticFeedback?.selectionChanged();
}
function setSleepMin(m){_slMin=m;_updateSleepDisplay();}
function setSleepQ(q){_sleepQ=q;document.querySelectorAll('#seg-sleepq .m3-seg-btn').forEach(b=>b.classList.toggle('on',+b.dataset.q===q));}

/* ‚ïê‚ïê CAL STEPPER ‚ïê‚ïê */
let _calVal=500,_calStep=1;
function _updateCalDisplay(){
  const e=document.getElementById('cal-preview');if(e)e.textContent=_calVal;
  const d=document.getElementById('cal-step-disp');if(d)d.textContent=_calVal;
}
function stepCal(delta){_calVal=Math.max(50,Math.min(3000,_calVal+delta));_updateCalDisplay();tg?.HapticFeedback?.selectionChanged();}
function setCalVal(v){
  _calVal=v;_updateCalDisplay();
  document.querySelectorAll('#cal-s2 .dur-grid .dur-btn').forEach(b=>b.classList.toggle('on',parseInt(b.textContent)===v));
  tg?.HapticFeedback?.selectionChanged();
}
function calStepNext(){
  _calStep=2;
  document.getElementById('cal-s1')?.classList.remove('active');
  document.getElementById('cal-s2')?.classList.add('active');
  const t=document.getElementById('cal-step-title');if(t)t.textContent='—Å–∫–æ–ª—å–∫–æ –∫–∞–ª–æ—Ä–∏–π?';
  const p1=document.getElementById('cp1'),p2=document.getElementById('cp2');
  if(p1){p1.classList.remove('on');p1.classList.add('done');}
  if(p2)p2.classList.add('on');
  tg?.HapticFeedback?.selectionChanged();
}
function calBackOrPop(){
  if(_calStep===2){
    _calStep=1;
    document.getElementById('cal-s2')?.classList.remove('active');
    document.getElementById('cal-s1')?.classList.add('active');
    const t=document.getElementById('cal-step-title');if(t)t.textContent='–Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞';
    const p1=document.getElementById('cp1'),p2=document.getElementById('cp2');
    if(p1){p1.classList.add('on');p1.classList.remove('done');}
    if(p2)p2.classList.remove('on');
  }else popPage();
}

/* ‚ïê‚ïê TIME PICKER ‚ïê‚ïê */
let _timeH=8,_timeM=0,_timeEH=9,_timeEM=0;
function _updateTimeDisplay(){
  const pad=v=>String(v).padStart(2,'0');
  const hd=document.getElementById('time-h-disp'),md=document.getElementById('time-m-disp');
  const ehd=document.getElementById('time-eh-disp'),emd=document.getElementById('time-em-disp');
  if(hd)hd.textContent=pad(_timeH);if(md)md.textContent=pad(_timeM);
  if(ehd)ehd.textContent=pad(_timeEH);if(emd)emd.textContent=pad(_timeEM);
  const inp=document.getElementById('inp-atime');if(inp)inp.value=pad(_timeH)+':'+pad(_timeM);
  const startMin=_timeH*60+_timeM,endMin=_timeEH*60+_timeEM;
  let dur=endMin-startMin;if(dur<=0)dur+=24*60;
  const dd=document.getElementById('act-dur-display');
  if(dd){if(dur>=60){const h=Math.floor(dur/60),m=dur%60;dd.textContent='–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: '+(h>0?h+' —á ':'')+(m>0?m+' –º–∏–Ω':'');}else{dd.textContent='–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: '+dur+' –º–∏–Ω';}}
  _actDur=dur;
}
function stepTime(part,dir){
  if(part==='sh')_timeH=(_timeH+dir+24)%24;
  else if(part==='sm')_timeM=(_timeM+dir*5+60)%60;
  else if(part==='eh')_timeEH=(_timeEH+dir+24)%24;
  else if(part==='em')_timeEM=(_timeEM+dir*5+60)%60;
  _updateTimeDisplay();tg?.HapticFeedback?.selectionChanged();
}

/* ‚ïê‚ïê OTHER SETTERS ‚ïê‚ïê */
let _mealType='breakfast',_gender='male';
function setMeal(m){_mealType=m;document.querySelectorAll('#seg-meal .m3-seg-btn').forEach(b=>b.classList.toggle('on',b.dataset.m===m));}
function setGender(g){_gender=g;document.querySelectorAll('#seg-gender .m3-seg-btn').forEach(b=>b.classList.toggle('on',b.dataset.g===g));}
function toggleCalMacros(){
  const wrap=$('cal-macros-wrap');const arrow=$('cal-macros-arrow');
  if(!wrap)return;
  const open=wrap.style.display==='none'||!wrap.style.display;
  wrap.style.display=open?'block':'none';
  if(arrow)arrow.style.transform=open?'rotate(180deg)':'rotate(0deg)';
}

/* ‚ïê‚ïê ACTIVITY FORM ‚ïê‚ïê */
let actStep=1,_actType='run',_actDur=45,_actDays=[];
const ACT_TITLES=['–Ω–∞–∑–≤–∞–Ω–∏–µ','–∫–æ–≥–¥–∞?','–ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ','–≥–æ—Ç–æ–≤–æ!'];
function _renderActStep(){
  [1,2,3,4].forEach(i=>{
    document.getElementById('act-s'+i)?.classList.toggle('active',i===actStep);
    const pip=document.getElementById('sp'+i);
    if(pip){pip.classList.toggle('on',i===actStep);pip.classList.toggle('done',i<actStep);if(i<actStep)pip.classList.remove('on');}
  });
  document.getElementById('act-step-title').textContent=ACT_TITLES[actStep-1];
  const btn=document.getElementById('act-next-btn');
  if(btn)btn.textContent=actStep===4?'‚úì –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–ª–∞–Ω':'–¥–∞–ª–µ–µ ‚Üí';
  if(actStep===4){
    const name=document.getElementById('inp-aname')?.value||'‚Äî';
    const time=document.getElementById('inp-atime')?.value||'08:00';
    const ico={run:'üèÉ',walk:'üö∂',bike:'üö¥',gym:'üí™',yoga:'üßò',swim:'üèä',other:'‚ú®'}[_actType]||'‚ú®';
    const ci=document.getElementById('act-confirm-ico');if(ci)ci.textContent=ico;
    const cn=document.getElementById('act-confirm-name');if(cn)cn.textContent=name;
    const ct=document.getElementById('act-confirm-time');if(ct)ct.textContent=time+' ¬∑ '+_actDur+' –º–∏–Ω';
    const cd=document.getElementById('act-confirm-days');
    if(cd){if(_actDays.length===0||_actDays.length===7)cd.textContent='–µ–∂–µ–¥–Ω–µ–≤–Ω–æ';else{const dnames=['–≤—Å','–ø–Ω','–≤—Ç','—Å—Ä','—á—Ç','–ø—Ç','—Å–±'];cd.textContent=_actDays.sort().map(d=>dnames[d]).join(', ');}}
  }
  tg?.HapticFeedback?.selectionChanged();
}
function actBackOrPop(){if(actStep>1){actStep--;_renderActStep();}else popPage();}
function actStepNext(){
  if(actStep===1){if(!(document.getElementById('inp-aname')?.value?.trim())){toast('–≤–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ');return;}actStep=2;_renderActStep();}
  else if(actStep===2){actStep=3;_renderActStep();}
  else if(actStep===3){actStep=4;_renderActStep();}
  else submitAct();
}
function actQuick(name,type,el){
  _actType=type;
  document.querySelectorAll('#act-quick .type-card').forEach(c=>c.classList.remove('on'));
  el?.classList.add('on');
  const inp=document.getElementById('inp-aname');if(inp)inp.value=name;
}
function toggleDayDaily(){
  _actDays=[];
  document.getElementById('day-btn-daily')?.classList.add('on');
  document.querySelectorAll('#days-grid .day-btn').forEach(b=>b.classList.remove('on'));
}
function toggleDay(day,el){
  document.getElementById('day-btn-daily')?.classList.remove('on');
  const idx=_actDays.indexOf(day);
  if(idx>=0){_actDays.splice(idx,1);el?.classList.remove('on');}
  else{_actDays.push(day);el?.classList.add('on');}
  if(_actDays.length===0)toggleDayDaily();
}

/* ‚ïê‚ïê LONG PRESS ‚ïê‚ïê */
let _lpTimer=null,_lpEl=null;
function startLongPress(id,el){
  if(_lpEl)cancelLongPress();
  _lpEl=el;
  _lpTimer=setTimeout(()=>{
    _lpTimer=null;
    const savedEl=_lpEl;_lpEl=null;
    tg?.HapticFeedback?.notificationOccurred('warning');
    navigator.vibrate?.([30,10,40]);
    const actName=savedEl?.querySelector('.ac-name')?.textContent||'–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å';
    if(confirm('—É–¥–∞–ª–∏—Ç—å ¬´'+actName+'¬ª?'))deleteActDirectly(id,savedEl);
  },700);
}
function cancelLongPress(){
  if(_lpTimer){clearTimeout(_lpTimer);_lpTimer=null;}
  _lpEl=null;
}

/* ‚ïê‚ïê DELETE ‚ïê‚ïê */
async function deleteActDirectly(id,cardEl){
  tg?.HapticFeedback?.notificationOccurred('warning');
  C.acts_today=C.acts_today.filter(x=>x.id!==id);
  if(!UID)lsSet('acts_'+TODAY,C.acts_today);
  if(_completingMap.has(id)){clearTimeout(_completingMap.get(id).hideTimer);_completingMap.delete(id);}

  function _afterDelete(){
    const acts=gActs();
    const done=acts.filter(a=>a.completed).length,total=acts.length;
    T('pl-cnt',total?`${done}/${total}`:'0/0');
    requestAnimationFrame(()=>{const r=$('pl-ring');if(r)r.setAttribute('stroke-dashoffset',125.7*(1-(total?done/total:0)));});
    renderHome();
  }

  toast('—É–¥–∞–ª–µ–Ω–æ');
  if(cardEl&&cardEl.parentNode){
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      cardEl.style.transition='opacity .25s ease, transform .25s ease';
      cardEl.style.opacity='0';
      cardEl.style.transform='translateX(32px) scale(0.95)';
      setTimeout(()=>{
        cardEl.style.transition='none';
        cardEl.style.height='0';cardEl.style.marginBottom='0';
        cardEl.style.paddingTop='0';cardEl.style.paddingBottom='0';
        cardEl.style.overflow='hidden';
        requestAnimationFrame(()=>{
          if(cardEl.parentNode)cardEl.remove();
          _afterDelete();
        });
      },260);
    }));
  }else{_afterDelete();}
  await apiPost('/api/activity/delete',{act_id:id});
}

/* ‚ïê‚ïê COMPLETING MAP ‚ïê‚ïê */
const _completingMap=new Map();

/* ‚ïê‚ïê COMPLETE ACT ‚ïê‚ïê */
async function completeAct(id){
  const act=C.acts_today.find(x=>x.id===id);
  if(!act)return;

  // Undo
  if(_completingMap.has(id)){
    const{hideTimer}=_completingMap.get(id);
    clearTimeout(hideTimer);_completingMap.delete(id);
    C.acts_today=C.acts_today.map(x=>x.id===id?{...x,completed:0}:x);
    if(!UID)lsSet('acts_'+TODAY,C.acts_today);
    const cardEl=document.querySelector(`#pl-list .ac[data-id="${id}"]`);
    if(cardEl){
      cardEl.classList.remove('done');
      const nameEl=cardEl.querySelector('.ac-name');if(nameEl)nameEl.classList.remove('done-text');
      const pill=cardEl.querySelector('.pill');if(pill){pill.className='pill p-later';pill.innerHTML='–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ';}
      const btn=cardEl.querySelector('.complete-btn-js');
      if(btn){btn.innerHTML='‚úì';btn.style.background='';btn.style.color='';btn.onclick=()=>completeAct(id);}
      const tb=cardEl.querySelector('.ac-timer-bar');if(tb)tb.remove();
      cardEl.style.transition='height .25s ease';cardEl.style.height='';cardEl.style.overflow='';
    }
    _updatePlanCounters();
    toast('–æ—Ç–º–µ–Ω–µ–Ω–æ');tg?.HapticFeedback?.notificationOccurred('warning');
    apiPost('/api/activity/uncomplete',{act_id:id});
    return;
  }

  if(act.completed)return;

  C.acts_today=C.acts_today.map(x=>x.id===id?{...x,completed:1}:x);
  if(!UID)lsSet('acts_'+TODAY,C.acts_today);
  _updatePlanCounters();
  renderHome();
  tg?.HapticFeedback?.notificationOccurred('success');
  toast('–≤—ã–ø–æ–ª–Ω–µ–Ω–æ üéâ');

  const cardEl=document.querySelector(`#pl-list .ac[data-id="${id}"]`);
  if(cardEl){
    cardEl.classList.add('done');
    const nameEl=cardEl.querySelector('.ac-name');if(nameEl)nameEl.classList.add('done-text');
    const pill=cardEl.querySelector('.pill');if(pill){pill.className='pill p-ok';pill.innerHTML='‚úì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ';}
    const btn=cardEl.querySelector('.complete-btn-js');
    if(btn){btn.innerHTML='‚Ü©';btn.style.background='rgba(82,193,119,.12)';btn.style.color='var(--green)';btn.onclick=(e)=>{e.stopPropagation();completeAct(id);};}

    const timerBar=document.createElement('div');
    timerBar.className='ac-timer-bar';timerBar.style.width='100%';
    cardEl.appendChild(timerBar);
    requestAnimationFrame(()=>requestAnimationFrame(()=>{timerBar.style.width='0%';}));

    const hideTimer=setTimeout(()=>{
      _completingMap.delete(id);
      requestAnimationFrame(()=>{
        // Fade + slide right ONLY ‚Äî no height collapse, button never jumps
        cardEl.style.transition='opacity .35s ease, transform .35s cubic-bezier(.4,0,.2,1)';
        cardEl.style.opacity='0';
        cardEl.style.transform='translateX(72px)';
        // After fade done ‚Äî collapse silently with no transition so it snaps away
        setTimeout(()=>{
          cardEl.style.transition='none';
          cardEl.style.height='0';
          cardEl.style.marginBottom='0';
          cardEl.style.paddingTop='0';
          cardEl.style.paddingBottom='0';
          cardEl.style.overflow='hidden';
          // Remove from DOM next frame so layout settles without animation
          requestAnimationFrame(()=>{
            if(cardEl.parentNode)cardEl.remove();
            if(_completingMap.size===0){reload().then(()=>{});}
          });
        },360);
      });
    },3600);

    _completingMap.set(id,{hideTimer});
    await apiPost('/api/activity/complete',{act_id:id});
  }else{
    _updatePlanCounters();
    await apiPost('/api/activity/complete',{act_id:id});
    await reload();
  }
}

function _updatePlanCounters(){
  const acts=gActs();
  const done=acts.filter(a=>a.completed).length,total=acts.length;
  T('pl-cnt',total?`${done}/${total}`:'0/0');
  requestAnimationFrame(()=>{const r=$('pl-ring');if(r)r.setAttribute('stroke-dashoffset',125.7*(1-(total?done/total:0)));});
}

function openDoneActs(){pushPage('pp-done-acts');}

/* ‚ïê‚ïê CLEAR / RESET ‚ïê‚ïê */
function clearWaterHistory(){
  if(!confirm('–æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –≤–æ–¥—É –∑–∞ —Å–µ–≥–æ–¥–Ω—è?'))return;
  C.water={total:0,entries:[],streak:C.water.streak||0};
  if(!UID)lsSet('wd_'+TODAY,{total:0,entries:[]});
  renderTrack('water');renderHome();toast('–∏—Å—Ç–æ—Ä–∏—è –≤–æ–¥—ã –æ—á–∏—â–µ–Ω–∞');
  if(curPushPage==='pp-water-hist')_populatePP('pp-water-hist');
  apiPost('/api/water/clear',{});
}
function clearSleepHistory(){
  if(!confirm('—É–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Å–Ω–∞?'))return;
  C.sleep_log=[];
  if(!UID)lsSet('slog',[]);
  renderSleep();renderHome();toast('–∏—Å—Ç–æ—Ä–∏—è —Å–Ω–∞ —É–¥–∞–ª–µ–Ω–∞');
  if(curPushPage==='pp-sleep-hist')_populatePP('pp-sleep-hist');
  apiPost('/api/sleep/clear',{});
}
function clearWeightHistory(){
  if(!confirm('—É–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –≤–µ—Å–∞?'))return;
  C.weight_log=[];
  if(!UID)lsSet('wlog',[]);
  renderProgress();renderHome();toast('–∏—Å—Ç–æ—Ä–∏—è –≤–µ—Å–∞ —É–¥–∞–ª–µ–Ω–∞');
  if(curPushPage==='pp-history')_populatePP('pp-history');
  apiPost('/api/weight/clear',{});
}
function resetAllData(){
  if(!confirm('—É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?\n–ø—Ä–æ—Ñ–∏–ª—å, –≤–µ—Å, —Å–æ–Ω, –≤–æ–¥–∞, –ø–ª–∞–Ω ‚Äî –≤—Å—ë –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ'))return;
  // Clear localStorage
  const keys=Object.keys(localStorage).filter(k=>k.startsWith('lf2_'));
  keys.forEach(k=>{try{localStorage.removeItem(k);}catch{}});
  // Reset in-memory
  const name=tgUser?.first_name||'–ì–æ—Å—Ç—å';
  C={
    user:{name,height:0,age:0,start_weight:0,goal_weight:0,water_goal:2000,cal_goal:2000,gender:'male',goal_type:'lose'},
    settings:{show_weight:1,show_water:1,show_calories:1,show_sleep:1},
    water:{total:0,entries:[],streak:0},calories:{},
    weight_log:[],sleep_log:[],acts_today:[],products:[]
  };
  _completingMap.clear();
  renderHome();renderProfile();renderProgress();renderPlan();renderSleep();renderTrack(trackTab);
  toast('–≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã');
  tg?.HapticFeedback?.notificationOccurred('warning');
  apiPost('/api/reset',{});
}

/* ‚ïê‚ïê SUBMIT ACTIONS ‚ïê‚ïê */
let _addWBusy=false;
async function addW(ml){
  if(_addWBusy)return;_addWBusy=true;
  C.water.total=(C.water.total||0)+ml;C.water.entries=[...(C.water.entries||[]),ml];
  if(!UID)lsSet('wd_'+TODAY,{total:C.water.total,entries:C.water.entries});
  renderTrack('water');renderHome();toast('+'+ml+' –º–ª');tg?.HapticFeedback?.impactOccurred('light');
  apiPost('/api/water',{amount:ml});setTimeout(()=>{_addWBusy=false;},250);
}
async function undoW(){
  if(!C.water.entries?.length){toast('–Ω–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å');return;}
  const last=C.water.entries.pop();C.water.total=Math.max(0,(C.water.total||0)-last);
  if(!UID)lsSet('wd_'+TODAY,{total:C.water.total,entries:C.water.entries});
  renderTrack('water');renderHome();toast('–æ—Ç–º–µ–Ω–µ–Ω–æ ‚àí'+last+' –º–ª');apiPost('/api/water/undo',{});
}
async function submitWeight(){
  const v=_wtInt+_wtDec/10;
  if(v<30||v>300){toast('–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å');return;}
  popPage();
  C.weight_log=[...(C.weight_log||[]),{weight:v,logged_at:TODAY}];
  // NEVER touch start_weight here ‚Äî it is only set via pp-start-weight screen
  if(!UID)lsSet('wlog',C.weight_log);
  renderHome();renderProgress();toast('–≤–µ—Å '+v.toFixed(1)+' –∫–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');tg?.HapticFeedback?.notificationOccurred('success');
  await apiPost('/api/weight',{weight:v});
  await reload();
}
async function submitSleep(){
  const hrs=_slH+(_slMin/60);
  popPage();
  C.sleep_log=[...(C.sleep_log||[]),{hours:hrs,quality:_sleepQ,logged_at:TODAY}];
  if(!UID)lsSet('slog',C.sleep_log);
  renderSleep();renderHome();toast('—Å–æ–Ω '+(_slH+(_slMin?'.5':''))+' —á —Å–æ—Ö—Ä–∞–Ω—ë–Ω');tg?.HapticFeedback?.notificationOccurred('success');
  await apiPost('/api/sleep',{hours:hrs,quality:_sleepQ});await reload();
}
async function submitCal(){
  const desc=document.getElementById('inp-cal-desc')?.value||'';
  if(!_calVal||_calVal<10){toast('–≤—ã–±–µ—Ä–∏ –∫–∞–ª–æ—Ä–∏–∏');return;}
  const prot=parseFloat(document.getElementById('inp-prot')?.value)||0;
  const fat=parseFloat(document.getElementById('inp-fat')?.value)||0;
  const carb=parseFloat(document.getElementById('inp-carb')?.value)||0;
  popPage();
  if(!C.calories)C.calories={};C.calories[_mealType]=(C.calories[_mealType]||0)+_calVal;
  if(!C.macros)C.macros={prot:0,fat:0,carb:0};
  C.macros.prot=+(( C.macros.prot||0)+prot).toFixed(1);
  C.macros.fat=+((C.macros.fat||0)+fat).toFixed(1);
  C.macros.carb=+((C.macros.carb||0)+carb).toFixed(1);
  if(!UID){lsSet('cd_'+TODAY,C.calories);lsSet('macros_'+TODAY,C.macros);}
  renderTrack('cal');renderHome();toast('+'+_calVal+' –∫–∫–∞–ª');tg?.HapticFeedback?.notificationOccurred('success');
  await apiPost('/api/calories',{amount:_calVal,meal_type:_mealType,description:desc,prot,fat,carb});await reload();
}
function _saveProfileSilent(){
  const name=document.getElementById('inp-pname')?.value?.trim();
  const height=parseInt(document.getElementById('inp-height')?.value);
  const age=parseInt(document.getElementById('inp-age')?.value);
  if(!name)return;
  C.user={...C.user,name,height:height||0,age:age||0,gender:_gender};
  if(!UID)lsSet('user',C.user);
  renderProfile();renderHome();toast('–ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  apiPost('/api/profile',{name,height:height||0,age:age||0,gender:_gender});
}
function _saveGoalsSilent(){
  const gw=parseFloat(document.getElementById('inp-gw')?.value)||0;
  const gwat=parseInt(document.getElementById('inp-gwat')?.value)||2000;
  const gcal=parseInt(document.getElementById('inp-gcal')?.value)||2000;
  C.user={...C.user,goal_weight:gw,water_goal:gwat,cal_goal:gcal};
  if(!UID)lsSet('user',C.user);
  renderProfile();renderHome();renderProgress();toast('—Ü–µ–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
  apiPost('/api/goals',{goal_weight:gw,water_goal:gwat,cal_goal:gcal});
}
async function submitAct(){
  const name=document.getElementById('inp-aname')?.value?.trim();
  const time=document.getElementById('inp-atime')?.value||'08:00';
  if(!name){toast('–≤–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ');return;}
  popPage();
  const fid=Date.now();
  const days=_actDays.length&&_actDays.length<7?_actDays:[];
  C.acts_today=[...(C.acts_today||[]),{id:fid,name,type:_actType,scheduled_at:`${TODAY}T${time}:00`,duration:_actDur,completed:0,repeat_days:days}];
  if(!UID)lsSet('acts_'+TODAY,C.acts_today);
  renderPlan();renderHome();toast(name+' –¥–æ–±–∞–≤–ª–µ–Ω–æ üéâ');tg?.HapticFeedback?.notificationOccurred('success');
  await apiPost('/api/activity/create',{name,type:_actType,time,duration:_actDur,repeat_days:days});await reload();
}

/* ‚ïê‚ïê HELPERS ‚ïê‚ïê */
const ACT_ICO={run:'üèÉ',walk:'üö∂',bike:'üö¥',gym:'üí™',yoga:'üßò',swim:'üèä',other:'‚ú®'};
const ACT_COL={run:'#FF6B35',walk:'#52C177',bike:'#4EAEE5',gym:'#E91E63',yoga:'#8B7FD4',swim:'#00BCD4',other:'#FFAB40'};
const $=id=>document.getElementById(id);
const T=(id,v)=>{const e=$(id);if(e)e.textContent=v;};
const H=(id,v)=>{const e=$(id);if(e)e.innerHTML=v;};
function dts(){const n=new Date(),y=n.getMonth()>=5?n.getFullYear()+1:n.getFullYear();return Math.ceil((new Date(y,5,1)-n)/86400000);}
function pD(n){const a=Math.abs(n)%100;if(a>=11&&a<=19)return'–¥–Ω–µ–π';if(a%10===1)return'–¥–µ–Ω—å';if(a%10>=2&&a%10<=4)return'–¥–Ω—è';return'–¥–Ω–µ–π';}
function fmtD(s){if(!s)return'‚Äî';try{const d=new Date(s+'T00:00:00');const m=['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];return d.getDate()+' '+m[d.getMonth()];}catch{return s;}}
function fmtMD(s){try{const d=new Date(s+'T00:00:00');return(d.getMonth()+1)+'/'+(d.getDate());}catch{return'';}}
function qIco(q){return['','üò´','üò¥','üòë','üôÇ','üåü'][q]||'üòë';}
function actStatus(a){
  const now=new Date(),[hh,mm]=(a.time||'00:00').split(':').map(Number);
  const st=new Date();st.setHours(hh,mm,0,0);const en=new Date(st.getTime()+(a.duration||30)*60000);
  if(a.completed)return{s:'done',l:'–≤—ã–ø–æ–ª–Ω–µ–Ω–æ'};
  if(now>en)return{s:'late',l:'–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ'};
  if(now>=st&&now<=en){const r=Math.round((en-now)/60000);return{s:'now',l:'–∏–¥—ë—Ç ¬∑ –µ—â—ë '+r+' –º–∏–Ω',p:(now-st)/(en-st)};}
  const df=Math.round((st-now)/60000);if(df<=30)return{s:'soon',l:'—á–µ—Ä–µ–∑ '+df+' –º–∏–Ω'};return{s:'later',l:'–≤ '+a.time};
}
function fmtRange(a){
  const[hh,mm]=(a.time||'00:00').split(':').map(Number);
  const eh=hh+Math.floor((mm+(a.duration||30))/60),em=(mm+(a.duration||30))%60;
  return`${a.time}‚Äì${String(eh%24).padStart(2,'0')}:${String(em).padStart(2,'0')}`;
}

let _tt;
function toast(msg){const el=$('toast');if(!el)return;el.textContent=msg;el.classList.add('show');clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove('show'),1800);}

/* ‚ïê‚ïê WEIGHT CHART ‚ïê‚ïê */
function drawWeightChart(data){
  const wrap=document.getElementById('wchart-svg-wrap');
  const container=document.getElementById('wchart-container');
  if(!wrap||!container)return;
  data=[...data].sort((a,b)=>(a.logged_at||'').localeCompare(b.logged_at||''));
  if(!data||data.length<2){
    wrap.innerHTML=`<div style="text-align:center;padding:48px 16px;color:var(--hint);font-size:13px;font-weight:700">–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞<br><span style="font-size:11px;opacity:.6">–∑–∞–ø–∏—à–∏ —Ö–æ—Ç—è –±—ã 2 –∑–∞–ø–∏—Å–∏ –≤–µ—Å–∞</span></div>`;
    return;
  }
  const byDate=new Map();
  data.forEach(d=>byDate.set(d.logged_at,d));
  data=[...byDate.values()].sort((a,b)=>a.logged_at.localeCompare(b.logged_at));
  const n=data.length;
  const containerW=container.clientWidth||320;
  const minColW=56;
  const W=Math.max(containerW-4,n*minColW+40);
  const H=160,PAD={l:36,r:16,t:32,b:28};
  const chartW=W-PAD.l-PAD.r,chartH=H-PAD.t-PAD.b;
  const ws=data.map(d=>d.weight);
  const rawMin=Math.min(...ws),rawMax=Math.max(...ws);
  const span=rawMax-rawMin||0.5;
  const mn=rawMin-span*0.2,mx=rawMax+span*0.2,rng=mx-mn;
  const xStep=n>1?chartW/(n-1):0;
  const pts=data.map((d,i)=>({x:PAD.l+i*xStep,y:PAD.t+chartH*(1-(d.weight-mn)/rng),w:d.weight,d:d.logged_at}));
  const dark=document.body.classList.contains('tg-dark');
  const accent='#FF6B35';
  const hintC=dark?'rgba(255,255,255,0.3)':'rgba(0,0,0,0.28)';
  const labelC=dark?'rgba(255,255,255,0.5)':'rgba(0,0,0,0.45)';
  const bg2C=dark?'#181818':'#ffffff';
  const gridC=dark?'rgba(255,255,255,0.07)':'rgba(0,0,0,0.06)';
  function makePath(pts){
    if(pts.length===1)return`M${pts[0].x},${pts[0].y}`;
    let d=`M${pts[0].x},${pts[0].y}`;
    for(let i=0;i<pts.length-1;i++){const cx=(pts[i].x+pts[i+1].x)/2;d+=` C${cx},${pts[i].y} ${cx},${pts[i+1].y} ${pts[i+1].x},${pts[i+1].y}`;}
    return d;
  }
  const linePath=makePath(pts);
  const fillPath=linePath+` L${pts[pts.length-1].x},${H-PAD.b+4} L${pts[0].x},${H-PAD.b+4} Z`;
  const uid=Math.random().toString(36).slice(2,7);
  const gradId='g'+uid,glowId='gw'+uid,clipId='cl'+uid;
  const yLabels=[0.15,0.5,0.85].map(f=>{
    const gy=PAD.t+chartH*f,val=mx-rng*f;
    return`<text x="${PAD.l-4}" y="${gy+4}" text-anchor="end" font-family="Onest,sans-serif" font-size="8.5" font-weight="700" fill="${hintC}">${val.toFixed(1)}</text>
    <line x1="${PAD.l}" y1="${gy}" x2="${W-PAD.r}" y2="${gy}" stroke="${gridC}" stroke-width="1" stroke-dasharray="3,3"/>`;
  }).join('');
  const lastIdx=pts.length-1;
  const dotsHTML=pts.map((p,i)=>{
    const isLast=i===lastIdx,r=isLast?5.5:3.5;
    const lbX=Math.max(PAD.l+10,Math.min(W-PAD.r-10,p.x));
    return`<circle cx="${p.x}" cy="${p.y}" r="${r}" fill="${accent}" opacity="${isLast?1:0.75}"/>
    <circle cx="${p.x}" cy="${p.y}" r="${r-1.8}" fill="${bg2C}"/>
    <text x="${lbX}" y="${p.y-9}" text-anchor="middle" font-family="Onest,sans-serif" font-size="${isLast?10:8.5}" font-weight="${isLast?900:700}" fill="${isLast?accent:labelC}">${p.w.toFixed(1)}</text>
    <text x="${lbX}" y="${H-PAD.b+14}" text-anchor="middle" font-family="Onest,sans-serif" font-size="8" font-weight="600" fill="${hintC}">${fmtMD(p.d)}</text>`;
  }).join('');
  const lastPt=pts[lastIdx];
  wrap.style.width=W+'px';wrap.style.minWidth=W+'px';wrap.style.display='block';
  wrap.innerHTML=`<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg" style="display:block;overflow:visible">
  <defs>
    <linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="${accent}" stop-opacity="0.25"/>
      <stop offset="100%" stop-color="${accent}" stop-opacity="0.02"/>
    </linearGradient>
    <filter id="${glowId}" x="-20%" y="-20%" width="140%" height="140%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <clipPath id="${clipId}"><rect x="${PAD.l}" y="0" width="${chartW}" height="${H}"/></clipPath>
  </defs>
  ${yLabels}
  <g clip-path="url(#${clipId})">
    <path d="${fillPath}" fill="url(#${gradId})"/>
    <path d="${linePath}" fill="none" stroke="${accent}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" filter="url(#${glowId})" opacity="0.5"/>
    <path d="${linePath}" fill="none" stroke="${accent}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <circle cx="${lastPt.x}" cy="${lastPt.y}" r="14" fill="${accent}" opacity="0.1">
      <animate attributeName="r" values="10;16;10" dur="2.8s" repeatCount="indefinite"/>
      <animate attributeName="opacity" values="0.1;0.04;0.1" dur="2.8s" repeatCount="indefinite"/>
    </circle>
  </g>
  ${dotsHTML}
</svg>`;
  setTimeout(()=>{container.scrollLeft=container.scrollWidth;},60);
}

function _populateWeightChart(){
  const wl=gWL();
  const data=wl.length>30?wl.slice(-30):wl;
  const sub=document.getElementById('wc-sub');
  if(sub)sub.textContent=data.length+' –∑–∞–ø–∏—Å–µ–π ¬∑ –ø–æ—Å–ª–µ–¥–Ω–∏–µ '+Math.min(30,data.length)+' –¥–Ω–µ–π';
  const statEl=document.getElementById('wc-stat-list');
  if(statEl&&wl.length){
    const cw=wl[wl.length-1].weight;
    const sw=Math.max(...wl.map(d=>d.weight));
    const best=Math.min(...wl.map(d=>d.weight));
    const gw=gU().goal_weight;
    statEl.innerHTML=`<div class="sb-row">
      <div class="sbox"><div class="sv" style="color:var(--sun)">${cw.toFixed(1)}</div><div class="sl">—Å–µ–π—á–∞—Å –∫–≥</div></div>
      <div class="sbox"><div class="sv" style="color:var(--red)">${sw.toFixed(1)}</div><div class="sl">–º–∞–∫—Å –∫–≥</div></div>
      <div class="sbox"><div class="sv" style="color:var(--green)">${best.toFixed(1)}</div><div class="sl">–º–∏–Ω –∫–≥</div></div>
      ${gw?`<div class="sbox"><div class="sv" style="color:var(--water)">${gw.toFixed(1)}</div><div class="sl">—Ü–µ–ª—å –∫–≥</div></div>`:''}
    </div>`;
  }
  requestAnimationFrame(()=>requestAnimationFrame(()=>drawWeightChart(data)));
}

/* ‚ïê‚ïê RENDERS ‚ïê‚ïê */
function renderHome(){
  const u=gU(),wl=gWL(),sl=gSL(),wd=gWD();
  T('h-name',u.name||'‚Äî');
  const now=new Date();
  const days=['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ','–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–≤—Ç–æ—Ä–Ω–∏–∫','—Å—Ä–µ–¥–∞','—á–µ—Ç–≤–µ—Ä–≥','–ø—è—Ç–Ω–∏—Ü–∞','—Å—É–±–±–æ—Ç–∞'];
  const mons=['—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è','–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'];
  T('h-date',days[now.getDay()]+', '+now.getDate()+' '+mons[now.getMonth()]);
  const dsl=dts();T('h-days',dsl);T('h-dunit',pD(dsl));T('h-ddays',dsl);
  const wt=wd.total||0,wg=u.water_goal||2000,wp=Math.min(1,wt/wg);
  T('arc-wpct',Math.round(wp*100)+'%');T('arc-wml',wt);
  requestAnimationFrame(()=>{const a=$('arc-w');if(a)a.setAttribute('stroke-dashoffset',163.4*(1-wp));});
  const ct=totalCal(),cg=u.cal_goal||2000,cp=Math.min(1,ct/cg);
  T('arc-cpct',Math.round(cp*100)+'%');T('arc-cval',ct);
  requestAnimationFrame(()=>{const a=$('arc-c');if(a)a.setAttribute('stroke-dashoffset',207.3*(1-cp));});
  // Show –ö–ë–ñ–£ macros below calorie arc if any data
  const mac=C.macros||{};
  const amEl=$('arc-macros');
  if(amEl){
    if((mac.prot||0)+(mac.fat||0)+(mac.carb||0)>0){
      amEl.innerHTML=`<span style="font-size:9px;font-weight:800;color:var(--green)">${mac.prot||0}–±</span><span style="font-size:9px;font-weight:800;color:var(--sun)">${mac.fat||0}–∂</span><span style="font-size:9px;font-weight:800;color:var(--sleep)">${mac.carb||0}—É</span>`;
    }else{amEl.innerHTML='';}
  }
  if(sl.length){
    const last=sl[sl.length-1];
    const sqEl=$('arc-sq');if(sqEl)sqEl.innerHTML=Array.from({length:5},(_,i)=>`<div class="sqd${i<last.quality?' on':''}"></div>`).join('');
    requestAnimationFrame(()=>{const a=$('arc-s');if(a)a.setAttribute('stroke-dashoffset',163.4*(1-Math.min(1,last.hours/9)));});
    T('arc-sh',last.hours.toFixed(1));
  }
  // Weight progress ‚Äî ONLY use explicit start_weight; never derive from log entries
  {const cw_h=wl.length?wl[wl.length-1].weight:null;
  const gw_h=u.goal_weight||0;
  const sw_h=u.start_weight&&u.start_weight>0?u.start_weight:null;
  T('h-wcur',cw_h!=null?cw_h.toFixed(1):'‚Äî');
  T('h-wgoal',gw_h?gw_h.toFixed(1):'‚Äî');
  if(cw_h!=null&&gw_h&&sw_h&&Math.abs(sw_h-gw_h)>0.01){
    const total=Math.abs(sw_h-gw_h),done=Math.abs(sw_h-cw_h);
    const pct=Math.min(100,Math.max(0,Math.round(done/total*100)));
    T('h-wpct',pct+'%');
    requestAnimationFrame(()=>{const b=$('h-wbar');if(b)b.style.width=pct+'%';});
  }else{
    T('h-wpct',sw_h&&gw_h?'0%':'‚Äî');
    requestAnimationFrame(()=>{const b=$('h-wbar');if(b)b.style.width='0%';});
  }}
  const streak=gStreak();
  const sw=$('h-streak-w');if(sw)sw.style.display=streak>=2?'':'none';
  T('h-sval',streak+' –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥');
  const acts=gActs();
  const ps=$('h-plan-sec'),pl=$('h-plan-list');
  if(ps&&pl){
    if(!acts.length){ps.style.display='none';}
    else{
      ps.style.display='';const nt=new Date();
      const current=acts.find(a=>{
        if(a.completed)return false;
        const[hh,mm]=(a.time||'00:00').split(':').map(Number);
        const at=new Date();at.setHours(hh,mm,0,0);const et=new Date(at.getTime()+(a.duration||30)*60000);
        return nt>=at&&nt<=et;
      });
      const upcoming=acts.filter(a=>{
        if(a.completed)return false;
        const[hh,mm]=(a.time||'00:00').split(':').map(Number);
        const at=new Date();at.setHours(hh,mm,0,0);return at>nt;
      }).sort((a,b)=>(a.time||'').localeCompare(b.time||''));
      const next=upcoming[0];
      const toShow=[current,next].filter(Boolean);
      if(!toShow.length){ps.style.display='none';}
      else{
        pl.innerHTML=toShow.map(a=>{
          const ico=ACT_ICO[a.type]||'‚ú®',col=ACT_COL[a.type]||'#FF9800',done=a.completed;
          const[hh,mm]=(a.time||'00:00').split(':').map(Number);
          const at=new Date();at.setHours(hh,mm,0,0);const et=new Date(at.getTime()+(a.duration||30)*60000);
          const ts=`${a.time}‚Äì${String(et.getHours()).padStart(2,'0')}:${String(et.getMinutes()).padStart(2,'0')}`;
          const isNow=nt>=at&&nt<=et;
          const badge=done?`<span class="pill p-ok">‚úì</span>`:isNow?`<span class="pill p-now">–∏–¥—ë—Ç —Å–µ–π—á–∞—Å</span>`:`<span class="pill p-soon">${a.time}</span>`;
          return`<div class="ac${done?' done':''}"><div class="ac-ico" style="background:${col}18">${done?'‚úÖ':ico}</div><div class="ac-body"><div class="ac-name">${a.name}</div><div class="ac-sub">${ts} ¬∑ ${a.duration} –º–∏–Ω</div></div>${badge}</div>`;
        }).join('');
      }
    }
  }
}

function renderTrack(tab){if(tab==='water')renderWater();else renderCal();}
function renderWater(){
  const u=gU(),wd=gWD();
  const wt=wd.total||0,wg=u.water_goal||2000,wp=Math.min(100,Math.round(wt/wg*100));
  T('w-total',wt);T('w-goal',wg);
  requestAnimationFrame(()=>{const b=$('w-bar');if(b)b.style.width=wp+'%';});
  const st=gStreak();
  H('w-streak',st>=2?`<div style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,107,53,.1);color:var(--sun);padding:4px 12px;border-radius:99px;font-size:11px;font-weight:800">üî• ${st} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>`:'');
}
function renderCal(){
  const u=gU(),cd=gCD();
  const ct=totalCal(),cg=u.cal_goal||2000,cp=Math.min(100,Math.round(ct/cg*100));
  T('c-total',ct);T('c-goal',cg);
  requestAnimationFrame(()=>{const b=$('c-bar');if(b)b.style.width=cp+'%';});
  const m=C.macros||{prot:0,fat:0,carb:0};
  T('c-prot',m.prot||0);T('c-fat',m.fat||0);T('c-carb',m.carb||0);
  const MEALS=[{k:'breakfast',i:'üåÖ',n:'–∑–∞–≤—Ç—Ä–∞–∫',col:'#FF9800'},{k:'lunch',i:'‚òÄÔ∏è',n:'–æ–±–µ–¥',col:'#FF6B35'},{k:'dinner',i:'üåô',n:'—É–∂–∏–Ω',col:'#8B7FD4'},{k:'snack',i:'üçë',n:'–ø–µ—Ä–µ–∫—É—Å',col:'#52C177'},{k:'other',i:'üåø',n:'–¥—Ä—É–≥–æ–µ',col:'#607D8B'}];
  H('c-meals',MEALS.map(m=>`<div class="mr"><div class="mr-ico" style="background:${m.col}18;color:${m.col}">${m.i}</div><div style="flex:1"><div class="mr-name">${m.n}</div>${!cd[m.k]?`<div class="t5" style="font-size:10px">–Ω–µ –∑–∞–ø–∏—Å–∞–Ω–æ</div>`:''}</div><div class="mr-kcal" style="${cd[m.k]?'color:var(--cal)':'color:var(--hint)'}">${cd[m.k]||'‚Äî'} ${cd[m.k]?'–∫–∫–∞–ª':''}</div></div>`).join(''));
}

function renderPlan(){
  if(_completingMap.size>0)return;
  const acts=gActs();const now=new Date();
  const mons=['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
  T('pl-date','—Å–µ–≥–æ–¥–Ω—è ¬∑ '+now.getDate()+' '+mons[now.getMonth()]);
  const done=acts.filter(a=>a.completed).length,total=acts.length;
  T('pl-cnt',total?`${done}/${total}`:'0/0');
  requestAnimationFrame(()=>{const r=$('pl-ring');if(r)r.setAttribute('stroke-dashoffset',125.7*(1-(total?done/total:0)));});
  const list=$('pl-list');
  const empty=$('pl-empty');
  const activeTasks=acts.filter(a=>!a.completed);
  if(!list)return;
  if(!activeTasks.length){
    list.innerHTML='';
    if(empty)empty.style.display='flex';
    return;
  }
  if(empty)empty.style.display='none';
  list.innerHTML=activeTasks.map(a=>{
    const ico=ACT_ICO[a.type]||'‚ú®',col=ACT_COL[a.type]||'#FF9800';
    const st=actStatus(a);
    const pc={done:'p-ok',now:'p-now',soon:'p-soon',late:'p-late',later:'p-later'}[st.s]||'p-later';
    const pct=st.s==='now'?Math.round((st.p||0)*100):0;
    const bar=['now','soon'].includes(st.s);
    return`<div class="ac" data-id="${a.id}" oncontextmenu="event.preventDefault()" ontouchstart="startLongPress(${a.id},this)" ontouchend="cancelLongPress()" ontouchmove="cancelLongPress()">
      <div class="ac-ico" style="background:${col}18">${ico}</div>
      <div class="ac-body">
        <div class="ac-name">${a.name}</div>
        <div class="ac-sub">${fmtRange(a)} ¬∑ ${a.duration} –º–∏–Ω</div>
        <span class="pill ${pc}">${st.l}</span>
        ${bar?`<div class="ac-bar"><div class="ac-barf" style="width:${st.s==='soon'?70:pct}%;background:${st.s==='now'?'var(--water)':'rgba(255,107,53,.35)'}"></div></div>`:''}
      </div>
      <div style="flex-shrink:0">
        <button class="btn btn-g complete-btn-js" style="padding:7px 11px;font-size:12px;border-radius:9px" onclick="completeAct(${a.id})">‚úì</button>
      </div>
    </div>`;
  }).join('');
}

setInterval(()=>{if(curTab==='plan'&&_completingMap.size===0)renderPlan();},30000);

function renderSleep(){
  const sl=gSL();
  if(sl.length){const last=sl[sl.length-1];T('sl-h',last.hours.toFixed(1));T('sl-qico',qIco(last.quality));H('sl-dots',Array.from({length:5},(_,i)=>`<div class="sqd${i<last.quality?' on':''}"></div>`).join(''));}
  else{T('sl-h','‚Äî');T('sl-qico','‚Äî');H('sl-dots','');}
  const l7=gSL().slice(-7).reverse();
  if(l7.length){T('sl-avg-h',+(l7.reduce((a,b)=>a+b.hours,0)/l7.length).toFixed(1));T('sl-avg-q',qIco(Math.round(l7.reduce((a,b)=>a+(b.quality||3),0)/l7.length))+' '+(l7.reduce((a,b)=>a+(b.quality||3),0)/l7.length).toFixed(1));}
}

function renderProgress(){
  const u=gU(),wl=gWL(),sl=gSL(),wd=gWD();
  if(wl.length){
    const cw=wl[wl.length-1].weight;
    const gw=u.goal_weight||0;
    // ONLY use explicitly set start_weight ‚Äî never derive from log entries
    const sw=u.start_weight&&u.start_weight>0?u.start_weight:null;

    T('pr-wcur',cw.toFixed(1));
    T('pr-wgoal',gw?gw.toFixed(1)+' –∫–≥':'‚Äî');
    T('pr-wgoal2',gw?gw.toFixed(1):'‚Äî');
    T('pr-wstart',sw!=null?sw.toFixed(1):'‚Äî');

    if(sw!=null&&gw&&Math.abs(sw-gw)>0.01){
      const total=Math.abs(sw-gw);
      const done=Math.abs(sw-cw);
      const pct=Math.min(100,Math.max(0,Math.round(done/total*100)));
      T('pr-wpct',pct+'%');
      requestAnimationFrame(()=>{const b=$('pr-wbar');if(b)b.style.width=pct+'%';});
      const isLosing=gw<sw;
      const diffVal=Math.max(0,isLosing?sw-cw:cw-sw);
      const rem=Math.max(0,Math.abs(cw-gw));
      T('pr-winfo',(isLosing?'–ø–æ—Ç–µ—Ä—è–Ω–æ ':'–Ω–∞–±—Ä–∞–Ω–æ ')+diffVal.toFixed(1)+' –∫–≥ ¬∑ –æ—Å—Ç–∞–ª–æ—Å—å '+rem.toFixed(1)+' –∫–≥');
    }else if(!sw){
      T('pr-wpct','‚Äî');T('pr-winfo','–∑–∞–¥–∞–π –Ω–∞—á–∞–ª—å–Ω—ã–π –≤–µ—Å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ—Ñ–∏–ª—è');
      requestAnimationFrame(()=>{const b=$('pr-wbar');if(b)b.style.width='0%';});
    }else if(!gw){
      T('pr-wpct','‚Äî');T('pr-winfo','—É–∫–∞–∂–∏ —Ü–µ–ª–µ–≤–æ–π –≤–µ—Å –≤ ¬´–º–æ–∏ —Ü–µ–ª–∏¬ª');
      requestAnimationFrame(()=>{const b=$('pr-wbar');if(b)b.style.width='0%';});
    }else{
      T('pr-wpct','0%');T('pr-winfo','');
      requestAnimationFrame(()=>{const b=$('pr-wbar');if(b)b.style.width='0%';});
    }

    // Forecast
    if(wl.length>=2&&gw&&sw){
      try{
        const d1=new Date(wl[0].logged_at+'T00:00:00'),d2=new Date(wl[wl.length-1].logged_at+'T00:00:00');
        const dd=Math.max(1,(d2-d1)/86400000);
        const rate=Math.abs(wl[0].weight-cw)/dd*7;
        if(rate>0.01){
          const dl=Math.ceil(Math.abs(cw-gw)/rate*7);
          const eta=new Date();eta.setDate(eta.getDate()+dl);
          const mons=['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
          T('pr-forecast','–ø—Ä–æ–≥–Ω–æ–∑: '+eta.getDate()+' '+mons[eta.getMonth()]+' ¬∑ —Ç–µ–º–ø '+rate.toFixed(2)+' –∫–≥/–Ω–µ–¥');
        }else T('pr-forecast','');
      }catch{T('pr-forecast','');}
    }else T('pr-forecast','');
  }else{
    T('pr-wcur','‚Äî');T('pr-wgoal','‚Äî');T('pr-wstart','‚Äî');
    T('pr-winfo','–∑–∞–ø–∏—à–∏ –ø–µ—Ä–≤—ã–π –≤–µ—Å –∏ —É–∫–∞–∂–∏ –Ω–∞—á–∞–ª—å–Ω—ã–π –≤–µ—Å');
    T('pr-wpct','‚Äî');
    requestAnimationFrame(()=>{const b=$('pr-wbar');if(b)b.style.width='0%';});
    T('pr-forecast','');
  }
  T('pw-water',wd.total||0);T('pw-cal',totalCal());
  T('pw-sleep',sl.length?+(sl.slice(-7).reduce((a,b)=>a+b.hours,0)/Math.min(7,sl.length)).toFixed(1):'‚Äî');
}

function renderProfile(){
  const u=gU(),wl=gWL();
  const av=$('pf-av');if(av)av.textContent=(u.name||'?').charAt(0).toUpperCase();
  T('pf-name',u.name||'‚Äî');
  const meta=[];if(u.age)meta.push(u.age+' –ª–µ—Ç');if(u.height)meta.push(u.height+' —Å–º');if(u.gender)meta.push(u.gender==='male'?'‚ôÇ':'‚ôÄ');
  T('pf-meta',meta.join(' ¬∑ ')||'‚Äî');
  T('pf-gw',u.goal_weight?u.goal_weight+' –∫–≥':'‚Äî');T('pf-pname',u.name||'‚Äî');
  // Show start weight + goal type
  const swLabel=u.start_weight&&u.start_weight>0
    ?(u.start_weight.toFixed(1)+' –∫–≥ ¬∑ '+(u.goal_type==='gain'?'–Ω–∞–±–æ—Ä':'–ø–æ—Ö—É–¥–µ–Ω–∏–µ'))
    :'–Ω–µ –∑–∞–¥–∞–Ω';
  T('pf-sw',swLabel);
  const bmiRow=$('pf-bmi-row');
  if(u.height&&wl.length){
    const cw=wl[wl.length-1].weight,h2=u.height/100;
    T('pf-bmi',+(cw/h2/h2).toFixed(1));T('pf-ideal',+((u.height-100)*.9).toFixed(1));
    T('pf-bmr',Math.round(u.gender==='female'?10*cw+6.25*u.height-5*(u.age||25)-161:10*cw+6.25*u.height-5*(u.age||25)+5));
    if(bmiRow)bmiRow.style.display='';
  }else if(bmiRow)bmiRow.style.display='none';
}

/* ‚ïê‚ïê PLAN SETTINGS ‚ïê‚ïê */
let _psDow = 1; // current selected day of week (1=Mon..7=Sun, 0=Sun)
const _dowLabels = ['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ','–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–≤—Ç–æ—Ä–Ω–∏–∫','—Å—Ä–µ–¥–∞','—á–µ—Ç–≤–µ—Ä–≥','–ø—è—Ç–Ω–∏—Ü–∞','—Å—É–±–±–æ—Ç–∞'];

function psDaySelect(dow, el){
  _psDow = dow;
  document.querySelectorAll('.ps-day-btn').forEach(b=>b.classList.toggle('on',+b.dataset.dow===dow));
  const lbl = _dowLabels[dow]||'–¥–µ–Ω—å';
  T('ps-day-label','–∑–∞–¥–∞—á–∏ –Ω–∞ '+lbl);
  _renderPsTasksList();
  tg?.HapticFeedback?.selectionChanged();
}

function _renderPsTasksList(){
  const el = $('ps-tasks-list'); if(!el)return;
  // All acts that repeat on this day (days_of_week includes _psDow) OR are daily (days_of_week empty)
  const allActs = C.acts_today || [];
  // We also look at repeat_days from activities directly
  // For now filter from C.acts_today using repeat_days or days_of_week
  const filtered = allActs.filter(a=>{
    if(!a.repeat_days && !a.days_of_week) return true; // daily
    const days = a.repeat_days||[];
    const dw = typeof a.days_of_week==='string'
      ? a.days_of_week.split(',').filter(Boolean).map(Number)
      : [];
    const combined = [...new Set([...days,...dw])];
    if(!combined.length) return true; // daily
    return combined.includes(_psDow);
  });
  if(!filtered.length){
    el.innerHTML='<div style="text-align:center;padding:24px;color:var(--hint);font-size:13px;font-weight:600">–Ω–µ—Ç –∑–∞–¥–∞—á</div>';
    return;
  }
  el.innerHTML = filtered.map(a=>{
    const ico=ACT_ICO[a.type]||'‚ú®',col=ACT_COL[a.type]||'#FF9800';
    const time=(a.scheduled_at||'').slice(11,16)||'00:00';
    return`<div class="ac" style="margin-bottom:8px" ontouchstart="startPsLongPress(${a.id},this)" ontouchend="cancelLongPress()" ontouchmove="cancelLongPress()" oncontextmenu="event.preventDefault()">
      <div class="ac-ico" style="background:${col}18">${ico}</div>
      <div class="ac-body">
        <div class="ac-name">${a.name}</div>
        <div class="ac-sub">${time} ¬∑ ${a.duration||30} –º–∏–Ω</div>
      </div>
      <div style="flex-shrink:0;font-size:10px;color:var(--hint);font-weight:700">—É–¥–µ—Ä–∂–∏<br>—á—Ç–æ–±—ã<br>—É–¥–∞–ª–∏—Ç—å</div>
    </div>`;
  }).join('');
}

let _psLpTimer=null,_psLpEl=null;
function startPsLongPress(id,el){
  if(_psLpEl)cancelLongPress();
  _psLpEl=el;
  _psLpTimer=setTimeout(()=>{
    _psLpTimer=null; const saved=_psLpEl; _psLpEl=null;
    tg?.HapticFeedback?.notificationOccurred('warning');
    navigator.vibrate?.([30,10,40]);
    const name=saved?.querySelector('.ac-name')?.textContent||'–∑–∞–¥–∞—á–∞';
    if(confirm('—É–¥–∞–ª–∏—Ç—å ¬´'+name+'¬ª?')){
      C.acts_today=C.acts_today.filter(x=>x.id!==id);
      if(!UID)lsSet('acts_'+TODAY,C.acts_today);
      if(saved&&saved.parentNode){
        saved.style.transition='opacity .2s';saved.style.opacity='0';
        setTimeout(()=>{if(saved.parentNode)saved.remove();},200);
      }
      _renderPsTasksList();
      renderPlan();renderHome();
      toast('—É–¥–∞–ª–µ–Ω–æ');
      apiPost('/api/activity/delete',{act_id:id});
    }
  },700);
}

/* ‚ïê‚ïê SCANNER ‚ïê‚ïê */
let _scanStream=null,_scanInterval=null,_scGrams=100,_scMealType='breakfast';
let _scFoundProduct=null,_scStep=1;

function _setScanStep(n){
  _scStep=n;
  [1,2,3].forEach(i=>{
    document.getElementById('sc-s'+i)?.classList.toggle('active',i===n);
    const pip=document.getElementById('scp'+i);
    if(pip){pip.classList.toggle('on',i===n);pip.classList.toggle('done',i<n);if(i<n)pip.classList.remove('on');}
  });
  const titles=['—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ','–ø—Ä–æ–¥—É–∫—Ç –∏ –ø–æ—Ä—Ü–∏—è','–¥–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–∏—ë–º'];
  T('sc-step-title',titles[n-1]);
}

function scannerBack(){
  if(_scStep>1){_setScanStep(_scStep-1);if(_scStep===1)startScanner();}
  else{stopScanner();popPage();}
}

async function startScanner(){
  const vp=$('scanner-viewport');
  const vid=$('scanner-video');
  const status=$('scanner-status');
  const nf=$('scanner-not-found');if(nf)nf.style.display='none';
  if(vp)vp.classList.remove('found');
  if(status)status.textContent='–Ω–∞–≤–µ–¥–∏ –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥';
  try{
    if(!_scanStream){
      _scanStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}});
    }
    if(vid){vid.srcObject=_scanStream;await vid.play();}
    _startBarcodeDetect(vid);
  }catch(e){
    if(status)status.textContent='–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ';
  }
}

function stopScanner(){
  if(_scanInterval){clearInterval(_scanInterval);_scanInterval=null;}
  if(_scanStream){_scanStream.getTracks().forEach(t=>t.stop());_scanStream=null;}
}

function _startBarcodeDetect(vid){
  if(_scanInterval){clearInterval(_scanInterval);_scanInterval=null;}
  if(!('BarcodeDetector' in window)){
    const st=$('scanner-status');if(st)st.textContent='–≤–≤–µ–¥–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤—Ä—É—á–Ω—É—é';
    return;
  }
  const detector=new BarcodeDetector({formats:['ean_13','ean_8','upc_a','upc_e','code_128','code_39','itf']});
  let scanning=true;
  _scanInterval=setInterval(async()=>{
    if(!scanning||!vid||vid.readyState<2)return;
    try{
      const codes=await detector.detect(vid);
      if(codes.length>0){
        scanning=false;
        clearInterval(_scanInterval);_scanInterval=null;
        const barcode=codes[0].rawValue;
        tg?.HapticFeedback?.notificationOccurred('success');
        navigator.vibrate?.([60]);
        const st=$('scanner-status');if(st)st.textContent='‚úì –Ω–∞–π–¥–µ–Ω: '+barcode;
        const vp=$('scanner-viewport');if(vp)vp.classList.add('found');
        await _lookupBarcode(barcode);
      }
    }catch{}
  },350);
}

function manualBarcode(){
  const inp=$('inp-barcode-manual');
  const code=(inp?.value||'').trim();
  if(!code){toast('–≤–≤–µ–¥–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥');return;}
  stopScanner();
  _lookupBarcode(code);
}

async function _lookupBarcode(barcode){
  const st=$('scanner-status');if(st)st.textContent='–∑–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ‚Ä¶';
  try{
    // Try Open Food Facts v2 API with more fields
    const resp=await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json?fields=product_name,product_name_ru,brands,nutriments,nutriments_estimated`);
    const data=await resp.json();
    if(data.status===1&&data.product){
      const p=data.product;
      const n=p.nutriments||{};
      // Parse energy: prefer energy-kcal_100g, fallback energy_100g (kJ ‚Üí /4.184), then 0
      let kcal=0;
      if(n['energy-kcal_100g']!=null&&n['energy-kcal_100g']!==''){kcal=parseFloat(n['energy-kcal_100g']);}
      else if(n['energy-kcal']!=null&&n['energy-kcal']!==''){kcal=parseFloat(n['energy-kcal']);}
      else if(n['energy_100g']!=null&&n['energy_100g']!==''){
        // OpenFoodFacts stores energy in kJ by default when energy-kcal is absent
        kcal=Math.round(parseFloat(n['energy_100g'])/4.184);
      }
      else if(n['energy']!=null&&n['energy']!==''){
        kcal=Math.round(parseFloat(n['energy'])/4.184);
      }
      // Parse macros with multiple fallback field names
      const parseMacro=(...keys)=>{for(const k of keys){if(n[k]!=null&&n[k]!=='')return+(parseFloat(n[k])||0).toFixed(1);}return 0;};
      const prot=parseMacro('proteins_100g','proteins','protein_100g','protein');
      const fat=parseMacro('fat_100g','fat','lipids_100g','total-fat_100g');
      const carb=parseMacro('carbohydrates_100g','carbohydrates','carbs_100g','sugars_100g');
      const name=p.product_name_ru||p.product_name||'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç';
      _scFoundProduct={
        name,
        brand:p.brands||'',
        kcal:Math.round(isNaN(kcal)?0:kcal),
        prot:isNaN(prot)?0:prot,
        fat:isNaN(fat)?0:fat,
        carb:isNaN(carb)?0:carb,
      };
      _showScanProductStep();
    }else{
      _showScannerNotFound(barcode);
    }
  }catch(e){_showScannerNotFound(barcode);}
}

function _showScanProductStep(){
  const p=_scFoundProduct;if(!p)return;
  T('sc-name',p.name);T('sc-brand',p.brand);
  T('sc-kcal',p.kcal);T('sc-prot',p.prot);T('sc-fat',p.fat);T('sc-carb',p.carb);
  _scGrams=100;
  _updateScCalc();
  stopScanner();
  _setScanStep(2);
}

function _updateScCalc(){
  if(!_scFoundProduct)return;
  const p=_scFoundProduct;
  const k=Math.round(p.kcal*_scGrams/100);
  const pr=+(p.prot*_scGrams/100).toFixed(1);
  const fa=+(p.fat*_scGrams/100).toFixed(1);
  const ca=+(p.carb*_scGrams/100).toFixed(1);
  T('sc-calc-kcal',k);T('sc-grams-label',_scGrams);
  T('sc-grams-disp',_scGrams);
  // update the grams display stepper value
  const gd=$('sc-grams-disp');if(gd)gd.innerHTML=_scGrams+'<span class="unit">–≥</span>';
  T('sc-calc-prot',pr);T('sc-calc-fat',fa);T('sc-calc-carb',ca);
}

function _showScannerNotFound(barcode){
  T('sc-barcode-val',barcode);
  const nf=$('scanner-not-found');if(nf)nf.style.display='';
  const st=$('scanner-status');if(st)st.textContent='–ø—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω';
  const vp=$('scanner-viewport');if(vp)vp.classList.remove('found');
}

function scannerRetry(){
  const nf=$('scanner-not-found');if(nf)nf.style.display='none';
  const inp=$('inp-barcode-manual');if(inp)inp.value='';
  const vp=$('scanner-viewport');if(vp)vp.classList.remove('found');
  const st=$('scanner-status');if(st)st.textContent='–Ω–∞–≤–µ–¥–∏ –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥';
  _setScanStep(1);
  startScanner();
}

function stepScGrams(d){
  _scGrams=Math.max(5,Math.min(2000,_scGrams+d));
  _updateScCalc();
  tg?.HapticFeedback?.selectionChanged();
}

function scGotoMeal(){
  if(!_scFoundProduct){toast('–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥—É–∫—Ç–µ');return;}
  const p=_scFoundProduct;
  const k=Math.round(p.kcal*_scGrams/100);
  T('sc-confirm-name',p.name+(p.brand?' ¬∑ '+p.brand:''));
  T('sc-confirm-kcal',k+' –∫–∫–∞–ª ¬∑ '+_scGrams+'–≥');
  _setScanStep(3);
}

function setScMeal(m,el){
  _scMealType=m;
  ['breakfast','lunch','dinner','snack'].forEach(x=>{document.getElementById('scm-'+x)?.classList.toggle('on',x===m);});
  tg?.HapticFeedback?.selectionChanged();
}

async function submitScanned(){
  if(!_scFoundProduct){toast('–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥—É–∫—Ç–µ');return;}
  const p=_scFoundProduct;
  const kcal=Math.round(p.kcal*_scGrams/100);
  const prot=+(p.prot*_scGrams/100).toFixed(1);
  const fat=+(p.fat*_scGrams/100).toFixed(1);
  const carb=+(p.carb*_scGrams/100).toFixed(1);
  const desc=p.name+' '+_scGrams+'–≥';
  stopScanner();popPage();
  if(!C.calories)C.calories={};
  C.calories[_scMealType]=(C.calories[_scMealType]||0)+kcal;
  if(!C.macros)C.macros={prot:0,fat:0,carb:0};
  C.macros.prot=+(( C.macros.prot||0)+prot).toFixed(1);
  C.macros.fat=+((C.macros.fat||0)+fat).toFixed(1);
  C.macros.carb=+((C.macros.carb||0)+carb).toFixed(1);
  if(!UID){lsSet('cd_'+TODAY,C.calories);lsSet('macros_'+TODAY,C.macros);}
  renderTrack('cal');renderHome();
  toast('+'+kcal+' –∫–∫–∞–ª ¬∑ '+desc);
  tg?.HapticFeedback?.notificationOccurred('success');
  navTo('track');setTTab('cal');
  await apiPost('/api/calories',{amount:kcal,meal_type:_scMealType,description:desc,prot,fat,carb});
  await reload();
}

/* ‚ïê‚ïê INIT ‚ïê‚ïê */
document.addEventListener('DOMContentLoaded',async()=>{
  document.getElementById('pre-theme')?.remove();
  const dark=tg?.colorScheme==='dark'||window.matchMedia?.('(prefers-color-scheme:dark)').matches;
  if(dark)document.body.classList.add('tg-dark');
  tg?.onEvent('themeChanged',()=>{document.body.classList.toggle('tg-dark',tg?.colorScheme==='dark');applyTheme();});
  await loadData();
  renderHome();
  setTimeout(()=>{
    const sp=document.getElementById('splash');
    if(sp){sp.classList.add('hiding');setTimeout(()=>sp.remove(),520);}
  },1200);
  setInterval(async()=>{if(curTab==='home'&&_completingMap.size===0){await loadData();renderHome();}},30000);
});
</script>
</body>
</html>